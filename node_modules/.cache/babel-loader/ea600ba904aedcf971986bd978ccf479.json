{"ast":null,"code":"import{PurchaseFromCatalogComposer}from'@nitrots/nitro-renderer';import{useCallback,useEffect,useMemo,useState}from'react';import{CatalogPurchaseState,CreateLinkEvent,GetClubMemberLevel,LocalizeText,LocalStorageKeys,Offer,SendMessageComposer}from'../../../../../api';import{Button,LayoutLoadingSpinnerView}from'../../../../../common';import{CatalogInitGiftEvent,CatalogPurchasedEvent,CatalogPurchaseFailureEvent,CatalogPurchaseNotAllowedEvent,CatalogPurchaseSoldOutEvent}from'../../../../../events';import{DispatchUiEvent,useCatalog,useLocalStorage,usePurse,UseUiEvent}from'../../../../../hooks';import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export const CatalogPurchaseWidgetView=props=>{const{noGiftOption=false,purchaseCallback=null}=props;const[purchaseWillBeGift,setPurchaseWillBeGift]=useState(false);const[purchaseState,setPurchaseState]=useState(CatalogPurchaseState.NONE);const[catalogSkipPurchaseConfirmation,setCatalogSkipPurchaseConfirmation]=useLocalStorage(LocalStorageKeys.CATALOG_SKIP_PURCHASE_CONFIRMATION,false);const{currentOffer=null,currentPage=null,purchaseOptions=null,setPurchaseOptions=null}=useCatalog();const{getCurrencyAmount=null}=usePurse();const onCatalogEvent=useCallback(event=>{switch(event.type){case CatalogPurchasedEvent.PURCHASE_SUCCESS:setPurchaseState(CatalogPurchaseState.NONE);return;case CatalogPurchaseFailureEvent.PURCHASE_FAILED:setPurchaseState(CatalogPurchaseState.FAILED);return;case CatalogPurchaseNotAllowedEvent.NOT_ALLOWED:setPurchaseState(CatalogPurchaseState.FAILED);return;case CatalogPurchaseSoldOutEvent.SOLD_OUT:setPurchaseState(CatalogPurchaseState.SOLD_OUT);return;}},[]);UseUiEvent(CatalogPurchasedEvent.PURCHASE_SUCCESS,onCatalogEvent);UseUiEvent(CatalogPurchaseFailureEvent.PURCHASE_FAILED,onCatalogEvent);UseUiEvent(CatalogPurchaseNotAllowedEvent.NOT_ALLOWED,onCatalogEvent);UseUiEvent(CatalogPurchaseSoldOutEvent.SOLD_OUT,onCatalogEvent);const isLimitedSoldOut=useMemo(()=>{if(!currentOffer)return false;if(purchaseOptions.extraParamRequired&&(!purchaseOptions.extraData||!purchaseOptions.extraData.length))return false;if(currentOffer.pricingModel===Offer.PRICING_MODEL_SINGLE){const product=currentOffer.product;if(product&&product.isUniqueLimitedItem)return!product.uniqueLimitedItemsLeft;}return false;},[currentOffer,purchaseOptions]);const purchase=function(){let isGift=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(!currentOffer)return;if(GetClubMemberLevel()<currentOffer.clubLevel){CreateLinkEvent('habboUI/open/hccenter');return;}if(isGift){DispatchUiEvent(new CatalogInitGiftEvent(currentOffer.page.pageId,currentOffer.offerId,purchaseOptions.extraData));return;}setPurchaseState(CatalogPurchaseState.PURCHASE);if(purchaseCallback){purchaseCallback();return;}let pageId=currentOffer.page.pageId;// if(pageId === -1)\n// {\n//     const nodes = getNodesByOfferId(currentOffer.offerId);\n//     if(nodes) pageId = nodes[0].pageId;\n// }\nSendMessageComposer(new PurchaseFromCatalogComposer(pageId,currentOffer.offerId,purchaseOptions.extraData,purchaseOptions.quantity));};useEffect(()=>{if(!currentOffer)return;return()=>{setPurchaseState(CatalogPurchaseState.NONE);setPurchaseOptions({quantity:1,extraData:null,extraParamRequired:false,previewStuffData:null});};},[currentOffer,setPurchaseOptions]);useEffect(()=>{let timeout=null;if(purchaseState===CatalogPurchaseState.CONFIRM||purchaseState===CatalogPurchaseState.FAILED){timeout=setTimeout(()=>setPurchaseState(CatalogPurchaseState.NONE),3000);}return()=>{if(timeout)clearTimeout(timeout);};},[purchaseState]);if(!currentOffer)return null;const PurchaseButton=()=>{const priceCredits=currentOffer.priceInCredits*purchaseOptions.quantity;const pricePoints=currentOffer.priceInActivityPoints*purchaseOptions.quantity;if(GetClubMemberLevel()<currentOffer.clubLevel)return/*#__PURE__*/_jsx(Button,{variant:\"danger\",disabled:true,children:LocalizeText('catalog.alert.hc.required')});if(isLimitedSoldOut)return/*#__PURE__*/_jsx(Button,{variant:\"danger\",disabled:true,children:LocalizeText('catalog.alert.limited_edition_sold_out.title')});if(priceCredits>getCurrencyAmount(-1))return/*#__PURE__*/_jsx(Button,{variant:\"danger\",disabled:true,children:LocalizeText('catalog.alert.notenough.title')});if(pricePoints>getCurrencyAmount(currentOffer.activityPointType))return/*#__PURE__*/_jsx(Button,{variant:\"danger\",disabled:true,children:LocalizeText('catalog.alert.notenough.activitypoints.title.'+currentOffer.activityPointType)});switch(purchaseState){case CatalogPurchaseState.CONFIRM:return/*#__PURE__*/_jsx(Button,{variant:\"warning\",onClick:event=>purchase(),children:LocalizeText('catalog.marketplace.confirm_title')});case CatalogPurchaseState.PURCHASE:return/*#__PURE__*/_jsx(Button,{disabled:true,children:/*#__PURE__*/_jsx(LayoutLoadingSpinnerView,{})});case CatalogPurchaseState.FAILED:return/*#__PURE__*/_jsx(Button,{variant:\"danger\",children:LocalizeText('generic.failed')});case CatalogPurchaseState.SOLD_OUT:return/*#__PURE__*/_jsx(Button,{variant:\"danger\",children:LocalizeText('generic.failed')+' - '+LocalizeText('catalog.alert.limited_edition_sold_out.title')});case CatalogPurchaseState.NONE:default:return/*#__PURE__*/_jsx(Button,{variant:\"success\",disabled:purchaseOptions.extraParamRequired&&(!purchaseOptions.extraData||!purchaseOptions.extraData.length),onClick:event=>setPurchaseState(CatalogPurchaseState.CONFIRM),children:LocalizeText('catalog.purchase_confirmation.'+(currentOffer.isRentOffer?'rent':'buy'))});}};return/*#__PURE__*/_jsxs(_Fragment,{children:[!noGiftOption&&!currentOffer.isRentOffer&&/*#__PURE__*/_jsx(Button,{disabled:purchaseOptions.quantity>1||!currentOffer.giftable||isLimitedSoldOut||purchaseOptions.extraParamRequired&&(!purchaseOptions.extraData||!purchaseOptions.extraData.length),onClick:event=>purchase(true),children:LocalizeText('catalog.purchase_confirmation.gift')}),/*#__PURE__*/_jsx(PurchaseButton,{})]});};","map":null,"metadata":{},"sourceType":"module"}