{"ast":null,"code":"import{AvatarFigurePartType,AvatarScaleType,AvatarSetType,PetFigureData,RoomObjectCategory,RoomObjectType,RoomObjectVariable,RoomSessionChatEvent,RoomUserData,RoomWidgetEnum,SystemChatStyleEnum,TextureUtils,Vector3d}from'@nitrots/nitro-renderer';import{GetAvatarRenderManager,GetConfigurationManager,GetRoomEngine,PlaySound}from'../../../..';import{LocalizeText}from'../../../../utils/LocalizeText';import{GetRoomObjectScreenLocation}from'../../GetRoomObjectScreenLocation';import{RoomWidgetUpdateChatEvent}from'../events';import{RoomWidgetHandler}from'./RoomWidgetHandler';export class RoomWidgetChatHandler extends RoomWidgetHandler{constructor(){super(...arguments);this._avatarColorCache=new Map();this._avatarImageCache=new Map();this._petImageCache=new Map();}processEvent(event){switch(event.type){case RoomSessionChatEvent.CHAT_EVENT:{const chatEvent=event;const roomObject=GetRoomEngine().getRoomObject(chatEvent.session.roomId,chatEvent.objectId,RoomObjectCategory.UNIT);const objectLocation=roomObject?roomObject.getLocation():new Vector3d();const bubbleLocation=GetRoomObjectScreenLocation(chatEvent.session.roomId,roomObject===null||roomObject===void 0?void 0:roomObject.id,RoomObjectCategory.UNIT);const userData=roomObject?this.container.roomSession.userDataManager.getUserDataByIndex(chatEvent.objectId):new RoomUserData(-1);let username='';let avatarColor=0;let imageUrl=null;let chatType=chatEvent.chatType;let styleId=chatEvent.style;let userType=0;let petType=-1;let text=chatEvent.message;if(userData){userType=userData.type;const figure=userData.figure;switch(userType){case RoomObjectType.PET:imageUrl=this.getPetImage(figure,2,true,64,roomObject.model.getValue(RoomObjectVariable.FIGURE_POSTURE));petType=new PetFigureData(figure).typeId;break;case RoomObjectType.USER:imageUrl=this.getUserImage(figure);break;case RoomObjectType.RENTABLE_BOT:case RoomObjectType.BOT:styleId=SystemChatStyleEnum.BOT;break;}avatarColor=this._avatarColorCache.get(figure);username=userData.name;}switch(chatType){case RoomSessionChatEvent.CHAT_TYPE_RESPECT:text=LocalizeText('widgets.chatbubble.respect',['username'],[username]);if(GetConfigurationManager().getValue('respect.options')['enabled'])PlaySound(GetConfigurationManager().getValue('respect.options')['sound']);break;case RoomSessionChatEvent.CHAT_TYPE_PETREVIVE:case RoomSessionChatEvent.CHAT_TYPE_PET_REBREED_FERTILIZE:case RoomSessionChatEvent.CHAT_TYPE_PET_SPEED_FERTILIZE:{let textKey='widget.chatbubble.petrevived';if(chatType===RoomSessionChatEvent.CHAT_TYPE_PET_REBREED_FERTILIZE){textKey='widget.chatbubble.petrefertilized;';}else if(chatType===RoomSessionChatEvent.CHAT_TYPE_PET_SPEED_FERTILIZE){textKey='widget.chatbubble.petspeedfertilized';}let targetUserName=null;const newRoomObject=GetRoomEngine().getRoomObject(chatEvent.session.roomId,chatEvent.extraParam,RoomObjectCategory.UNIT);if(newRoomObject){const newUserData=this.container.roomSession.userDataManager.getUserDataByIndex(roomObject.id);if(newUserData)targetUserName=newUserData.name;}text=LocalizeText(textKey,['petName','userName'],[username,targetUserName]);break;}case RoomSessionChatEvent.CHAT_TYPE_PETRESPECT:text=LocalizeText('widget.chatbubble.petrespect',['petname'],[username]);break;case RoomSessionChatEvent.CHAT_TYPE_PETTREAT:text=LocalizeText('widget.chatbubble.pettreat',['petname'],[username]);break;case RoomSessionChatEvent.CHAT_TYPE_HAND_ITEM_RECEIVED:text=LocalizeText('widget.chatbubble.handitem',['username','handitem'],[username,LocalizeText('handitem'+chatEvent.extraParam)]);break;case RoomSessionChatEvent.CHAT_TYPE_MUTE_REMAINING:{const hours=(chatEvent.extraParam>0?Math.floor(chatEvent.extraParam/3600):0).toString();const minutes=(chatEvent.extraParam>0?Math.floor(chatEvent.extraParam%3600/60):0).toString();const seconds=(chatEvent.extraParam%60).toString();text=LocalizeText('widget.chatbubble.mutetime',['hours','minutes','seconds'],[hours,minutes,seconds]);break;}}this.container.eventDispatcher.dispatchEvent(new RoomWidgetUpdateChatEvent(RoomWidgetUpdateChatEvent.CHAT_EVENT,userData.roomIndex,text,username,RoomObjectCategory.UNIT,userType,petType,bubbleLocation.x,bubbleLocation.y,imageUrl,avatarColor,chatEvent.session.roomId,chatType,styleId,[]));return;}}}processWidgetMessage(message){return null;}getUserImage(figure){let existing=this._avatarImageCache.get(figure);if(!existing){existing=this.setFigureImage(figure);}return existing;}setFigureImage(figure){const avatarImage=GetAvatarRenderManager().createAvatarImage(figure,AvatarScaleType.LARGE,null,this);if(!avatarImage)return;const image=avatarImage.getCroppedImage(AvatarSetType.HEAD);const color=avatarImage.getPartColor(AvatarFigurePartType.CHEST);this._avatarColorCache.set(figure,color&&color.rgb||16777215);avatarImage.dispose();this._avatarImageCache.set(figure,image.src);return image.src;}getPetImage(figure,direction,_arg_3){let scale=arguments.length>3&&arguments[3]!==undefined?arguments[3]:64;let posture=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;let existing=this._petImageCache.get(figure+posture);if(existing)return existing;const figureData=new PetFigureData(figure);const typeId=figureData.typeId;const image=GetRoomEngine().getRoomObjectPetImage(typeId,figureData.paletteId,figureData.color,new Vector3d(direction*45),scale,null,false,0,figureData.customParts,posture);if(image){existing=TextureUtils.generateImageUrl(image.data);this._petImageCache.set(figure+posture,existing);}return existing;}resetFigure(figure){this.setFigureImage(figure);}dispose(){}get disposed(){return false;}get type(){return RoomWidgetEnum.CHAT_WIDGET;}get eventTypes(){return[RoomSessionChatEvent.CHAT_EVENT];}get messageTypes(){return[];}}","map":null,"metadata":{},"sourceType":"module"}