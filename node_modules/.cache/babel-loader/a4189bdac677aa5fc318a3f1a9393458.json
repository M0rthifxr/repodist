{"ast":null,"code":"import{GetGuestRoomResultEvent,RoomSessionChatEvent,RoomSessionEvent}from'@nitrots/nitro-renderer';import{useCallback,useState}from'react';import{GetRoomSession}from'../../api';import{UseMessageEventHook,UseRoomSessionManagerEvent}from'../../hooks';import{useChatHistoryContext}from'./ChatHistoryContext';import{ChatEntryType}from'./common/ChatEntryType';import{currentDate}from'./common/Utilities';const CHAT_HISTORY_MAX=1000;const ROOM_HISTORY_MAX=10;export const ChatHistoryMessageHandler=props=>{const{chatHistoryState=null,roomHistoryState=null}=useChatHistoryContext();const[needsRoomInsert,setNeedsRoomInsert]=useState(false);const addChatEntry=useCallback(entry=>{entry.id=chatHistoryState.chats.length;chatHistoryState.chats.push(entry);//check for overflow\nif(chatHistoryState.chats.length>CHAT_HISTORY_MAX){chatHistoryState.chats.shift();}chatHistoryState.notify();//dispatchUiEvent(new ChatHistoryEvent(ChatHistoryEvent.CHAT_HISTORY_CHANGED));\n},[chatHistoryState]);const addRoomHistoryEntry=useCallback(entry=>{roomHistoryState.roomHistory.push(entry);// check for overflow\nif(roomHistoryState.roomHistory.length>ROOM_HISTORY_MAX){roomHistoryState.roomHistory.shift();}roomHistoryState.notify();},[roomHistoryState]);const onChatEvent=useCallback(event=>{const roomSession=GetRoomSession();if(!roomSession)return;const userData=roomSession.userDataManager.getUserDataByIndex(event.objectId);if(!userData)return;const timeString=currentDate();const entry={id:-1,entityId:userData.webID,name:userData.name,look:userData.figure,entityType:userData.type,message:event.message,timestamp:timeString,type:ChatEntryType.TYPE_CHAT,roomId:roomSession.roomId};addChatEntry(entry);},[addChatEntry]);UseRoomSessionManagerEvent(RoomSessionChatEvent.CHAT_EVENT,onChatEvent);const onRoomSessionEvent=useCallback(event=>{switch(event.type){case RoomSessionEvent.STARTED:setNeedsRoomInsert(true);break;case RoomSessionEvent.ENDED://dispatchUiEvent(new ChatHistoryEvent(ChatHistoryEvent.HIDE_CHAT_HISTORY));\nbreak;}},[]);UseRoomSessionManagerEvent(RoomSessionEvent.ENDED,onRoomSessionEvent);UseRoomSessionManagerEvent(RoomSessionEvent.STARTED,onRoomSessionEvent);const onGetGuestRoomResultEvent=useCallback(event=>{const parser=event.getParser();if(!parser)return;const session=GetRoomSession();if(!session||session.roomId!==parser.data.roomId)return;if(needsRoomInsert){const chatEntry={id:-1,entityId:parser.data.roomId,name:parser.data.roomName,timestamp:currentDate(),type:ChatEntryType.TYPE_ROOM_INFO,roomId:parser.data.roomId};addChatEntry(chatEntry);const roomEntry={id:parser.data.roomId,name:parser.data.roomName};addRoomHistoryEntry(roomEntry);setNeedsRoomInsert(false);}},[addChatEntry,addRoomHistoryEntry,needsRoomInsert]);UseMessageEventHook(GetGuestRoomResultEvent,onGetGuestRoomResultEvent);return null;};","map":null,"metadata":{},"sourceType":"module"}