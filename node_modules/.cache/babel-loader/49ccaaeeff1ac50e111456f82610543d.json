{"ast":null,"code":"import{AvatarEditorFigureCategory,FigureSetIdsMessageEvent,GetWardrobeMessageComposer,UserFigureComposer,UserWardrobePageEvent}from'@nitrots/nitro-renderer';import{useCallback,useEffect,useMemo,useState}from'react';import{AddEventLinkTracker,GetAvatarRenderManager,GetClubMemberLevel,GetConfiguration,GetSessionDataManager,LocalizeText,RemoveLinkEventTracker,SendMessageComposer}from'../../api';import{NitroCardContentView,NitroCardHeaderView,NitroCardTabsItemView,NitroCardTabsView,NitroCardView}from'../../common';import{Button}from'../../common/Button';import{Column}from'../../common/Column';import{Grid}from'../../common/Grid';import{UseMessageEventHook}from'../../hooks';import{AvatarEditorAction}from'./common/AvatarEditorAction';import{AvatarEditorUtilities}from'./common/AvatarEditorUtilities';import{BodyModel}from'./common/BodyModel';import{FigureData}from'./common/FigureData';import{generateRandomFigure}from'./common/FigureGenerator';import{HeadModel}from'./common/HeadModel';import{LegModel}from'./common/LegModel';import{TorsoModel}from'./common/TorsoModel';import{AvatarEditorFigurePreviewView}from'./views/figure-preview/AvatarEditorFigurePreviewView';import{AvatarEditorModelView}from'./views/model/AvatarEditorModelView';import{AvatarEditorWardrobeView}from'./views/wardrobe/AvatarEditorWardrobeView';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const DEFAULT_MALE_FIGURE='hr-100.hd-180-7.ch-215-66.lg-270-79.sh-305-62.ha-1002-70.wa-2007';const DEFAULT_FEMALE_FIGURE='hr-515-33.hd-600-1.ch-635-70.lg-716-66-62.sh-735-68';export const AvatarEditorView=props=>{const[isVisible,setIsVisible]=useState(false);const[figures,setFigures]=useState(null);const[figureData,setFigureData]=useState(null);const[categories,setCategories]=useState(null);const[activeCategory,setActiveCategory]=useState(null);const[figureSetIds,setFigureSetIds]=useState([]);const[boundFurnitureNames,setBoundFurnitureNames]=useState([]);const[savedFigures,setSavedFigures]=useState([]);const[isWardrobeVisible,setIsWardrobeVisible]=useState(false);const[lastFigure,setLastFigure]=useState(null);const[lastGender,setLastGender]=useState(null);const[needsReset,setNeedsReset]=useState(true);const[isInitalized,setIsInitalized]=useState(false);const maxWardrobeSlots=useMemo(()=>GetConfiguration('avatar.wardrobe.max.slots',10),[]);const onFigureSetIdsMessageEvent=useCallback(event=>{const parser=event.getParser();setFigureSetIds(parser.figureSetIds);setBoundFurnitureNames(parser.boundsFurnitureNames);},[]);UseMessageEventHook(FigureSetIdsMessageEvent,onFigureSetIdsMessageEvent);const onUserWardrobePageEvent=useCallback(event=>{const parser=event.getParser();const savedFigures=[];let i=0;while(i<maxWardrobeSlots){savedFigures.push([null,null]);i++;}for(let[index,[look,gender]]of parser.looks.entries()){const container=GetAvatarRenderManager().createFigureContainer(look);savedFigures[index-1]=[container,gender];}setSavedFigures(savedFigures);},[maxWardrobeSlots]);UseMessageEventHook(UserWardrobePageEvent,onUserWardrobePageEvent);const selectCategory=useCallback(name=>{if(!categories)return;setActiveCategory(categories.get(name));},[categories]);const resetCategories=useCallback(()=>{const categories=new Map();categories.set(AvatarEditorFigureCategory.GENERIC,new BodyModel());categories.set(AvatarEditorFigureCategory.HEAD,new HeadModel());categories.set(AvatarEditorFigureCategory.TORSO,new TorsoModel());categories.set(AvatarEditorFigureCategory.LEGS,new LegModel());setCategories(categories);},[]);const setupFigures=useCallback(()=>{const figures=new Map();const maleFigure=new FigureData();const femaleFigure=new FigureData();maleFigure.loadAvatarData(DEFAULT_MALE_FIGURE,FigureData.MALE);femaleFigure.loadAvatarData(DEFAULT_FEMALE_FIGURE,FigureData.FEMALE);figures.set(FigureData.MALE,maleFigure);figures.set(FigureData.FEMALE,femaleFigure);setFigures(figures);setFigureData(figures.get(FigureData.MALE));},[]);const loadAvatarInEditor=useCallback(function(figure,gender){let reset=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;gender=AvatarEditorUtilities.getGender(gender);let newFigureData=figureData;if(gender!==newFigureData.gender)newFigureData=figures.get(gender);if(figure!==newFigureData.getFigureString())newFigureData.loadAvatarData(figure,gender);if(newFigureData!==figureData)setFigureData(newFigureData);if(reset){setLastFigure(figureData.getFigureString());setLastGender(figureData.gender);}},[figures,figureData]);const processAction=useCallback(action=>{switch(action){case AvatarEditorAction.ACTION_CLEAR:loadAvatarInEditor(figureData.getFigureStringWithFace(0,false),figureData.gender,false);resetCategories();return;case AvatarEditorAction.ACTION_RESET:loadAvatarInEditor(lastFigure,lastGender);resetCategories();return;case AvatarEditorAction.ACTION_RANDOMIZE:const figure=generateRandomFigure(figureData,figureData.gender,GetClubMemberLevel(),figureSetIds,[FigureData.FACE]);loadAvatarInEditor(figure,figureData.gender,false);resetCategories();return;case AvatarEditorAction.ACTION_SAVE:SendMessageComposer(new UserFigureComposer(figureData.gender,figureData.getFigureString()));setIsVisible(false);return;}},[figureData,lastFigure,lastGender,figureSetIds,loadAvatarInEditor,resetCategories]);const setGender=useCallback(gender=>{gender=AvatarEditorUtilities.getGender(gender);setFigureData(figures.get(gender));},[figures]);const linkReceived=useCallback(url=>{const parts=url.split('/');if(parts.length<2)return;switch(parts[1]){case'show':setIsVisible(true);return;case'hide':setIsVisible(false);return;case'toggle':setIsVisible(prevValue=>!prevValue);return;}},[]);useEffect(()=>{const linkTracker={linkReceived,eventUrlPrefix:'avatar-editor/'};AddEventLinkTracker(linkTracker);return()=>RemoveLinkEventTracker(linkTracker);},[linkReceived]);useEffect(()=>{setSavedFigures(new Array(maxWardrobeSlots));},[maxWardrobeSlots]);useEffect(()=>{if(!isWardrobeVisible)return;setActiveCategory(null);SendMessageComposer(new GetWardrobeMessageComposer());},[isWardrobeVisible]);useEffect(()=>{if(!activeCategory)return;setIsWardrobeVisible(false);},[activeCategory]);useEffect(()=>{if(!categories)return;selectCategory(AvatarEditorFigureCategory.GENERIC);},[categories,selectCategory]);useEffect(()=>{if(!figureData)return;AvatarEditorUtilities.CURRENT_FIGURE=figureData;resetCategories();return()=>AvatarEditorUtilities.CURRENT_FIGURE=null;},[figureData,resetCategories]);useEffect(()=>{AvatarEditorUtilities.FIGURE_SET_IDS=figureSetIds;AvatarEditorUtilities.BOUND_FURNITURE_NAMES=boundFurnitureNames;resetCategories();return()=>{AvatarEditorUtilities.FIGURE_SET_IDS=null;AvatarEditorUtilities.BOUND_FURNITURE_NAMES=null;};},[figureSetIds,boundFurnitureNames,resetCategories]);useEffect(()=>{if(!isVisible)return;if(!figures){setupFigures();setIsInitalized(true);return;}},[isVisible,figures,setupFigures]);useEffect(()=>{if(!isVisible||!isInitalized||!needsReset)return;loadAvatarInEditor(GetSessionDataManager().figure,GetSessionDataManager().gender);setNeedsReset(false);},[isVisible,isInitalized,needsReset,loadAvatarInEditor]);useEffect(()=>{if(isVisible)return;return()=>{setNeedsReset(true);};},[isVisible]);if(!isVisible||!figureData)return null;return/*#__PURE__*/_jsxs(NitroCardView,{uniqueKey:\"avatar-editor\",className:\"nitro-avatar-editor\",children:[/*#__PURE__*/_jsx(NitroCardHeaderView,{headerText:LocalizeText('avatareditor.title'),onCloseClick:event=>setIsVisible(false)}),/*#__PURE__*/_jsxs(NitroCardTabsView,{className:\"avatar-editor-tabs\",children:[categories&&categories.size>0&&Array.from(categories.keys()).map(category=>{const isActive=activeCategory&&activeCategory.name===category;return/*#__PURE__*/_jsx(NitroCardTabsItemView,{isActive:isActive,onClick:event=>selectCategory(category),children:LocalizeText(`avatareditor.category.${category}`)},category);}),/*#__PURE__*/_jsx(NitroCardTabsItemView,{isActive:isWardrobeVisible,onClick:event=>setIsWardrobeVisible(true),children:LocalizeText('avatareditor.category.wardrobe')})]}),/*#__PURE__*/_jsx(NitroCardContentView,{children:/*#__PURE__*/_jsxs(Grid,{children:[/*#__PURE__*/_jsxs(Column,{size:6,overflow:\"hidden\",children:[activeCategory&&!isWardrobeVisible&&/*#__PURE__*/_jsx(AvatarEditorModelView,{model:activeCategory,gender:figureData.gender,setGender:setGender}),isWardrobeVisible&&/*#__PURE__*/_jsx(AvatarEditorWardrobeView,{figureData:figureData,savedFigures:savedFigures,setSavedFigures:setSavedFigures,loadAvatarInEditor:loadAvatarInEditor})]}),/*#__PURE__*/_jsxs(Column,{size:3,overflow:\"hidden\",children:[/*#__PURE__*/_jsx(AvatarEditorFigurePreviewView,{figureData:figureData}),/*#__PURE__*/_jsx(Column,{className:\"randomize-container position-absolute\",children:/*#__PURE__*/_jsx(\"i\",{className:\"icon randomize-icon\",onClick:event=>processAction(AvatarEditorAction.ACTION_RANDOMIZE)})}),/*#__PURE__*/_jsx(Column,{grow:true,gap:1,children:/*#__PURE__*/_jsx(Button,{className:\"w-100\",variant:\"success\",onClick:event=>processAction(AvatarEditorAction.ACTION_SAVE),children:LocalizeText('avatareditor.save')})})]})]})})]});};","map":null,"metadata":{},"sourceType":"module"}