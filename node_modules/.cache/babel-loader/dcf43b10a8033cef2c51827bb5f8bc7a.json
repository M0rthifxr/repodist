{"ast":null,"code":"import{FontAwesomeIcon}from'@fortawesome/react-fontawesome';import{TradingListAddItemComposer,TradingListAddItemsComposer}from'@nitrots/nitro-renderer';import{useEffect,useState}from'react';import{FurniCategory,getGuildFurniType,LocalizeText,NotificationAlertType,NotificationUtilities,SendMessageComposer,TradeState}from'../../../../api';import{AutoGrid,Base,Button,Column,Flex,Grid,LayoutGridItem,Text}from'../../../../common';import{useInventoryTrade}from'../../../../hooks';import{InventoryFurnitureSearchView}from'./InventoryFurnitureSearchView';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const MAX_ITEMS_TO_TRADE=9;export const InventoryTradeView=props=>{const{cancelTrade=null}=props;const[groupItem,setGroupItem]=useState(null);const[ownGroupItem,setOwnGroupItem]=useState(null);const[otherGroupItem,setOtherGroupItem]=useState(null);const[filteredGroupItems,setFilteredGroupItems]=useState(null);const[countdownTick,setCountdownTick]=useState(3);const{ownUser=null,otherUser=null,groupItems=[],tradeState=TradeState.TRADING_STATE_READY,progressTrade=null,removeItem=null,setTradeState=null}=useInventoryTrade();const canTradeItem=(isWallItem,spriteId,category,groupable,stuffData)=>{if(!ownUser||ownUser.accepts||!ownUser.userItems)return false;if(ownUser.userItems.length<MAX_ITEMS_TO_TRADE)return true;if(!groupable)return false;let type=spriteId.toString();if(category===FurniCategory.POSTER){type=type+'poster'+stuffData.getLegacyString();}else{if(category===FurniCategory.GUILD_FURNI){type=getGuildFurniType(spriteId,stuffData);}else{type=(isWallItem?'I':'S')+type;}}return!!ownUser.userItems.getValue(type);};const attemptItemOffer=count=>{if(!groupItem)return;const tradeItems=groupItem.getTradeItems(count);if(!tradeItems||!tradeItems.length)return;let coreItem=null;const itemIds=[];for(const item of tradeItems){itemIds.push(item.id);if(!coreItem)coreItem=item;}const ownItemCount=ownUser.userItems.length;if(ownItemCount+itemIds.length<=1500){if(!coreItem.isGroupable&&itemIds.length){SendMessageComposer(new TradingListAddItemComposer(itemIds.pop()));}else{const tradeIds=[];for(const itemId of itemIds){if(canTradeItem(coreItem.isWallItem,coreItem.type,coreItem.category,coreItem.isGroupable,coreItem.stuffData)){tradeIds.push(itemId);}}if(tradeIds.length){if(tradeIds.length===1){SendMessageComposer(new TradingListAddItemComposer(tradeIds.pop()));}else{SendMessageComposer(new TradingListAddItemsComposer(...tradeIds));}}}}else{NotificationUtilities.simpleAlert(LocalizeText('trading.items.too_many_items.desc'),NotificationAlertType.DEFAULT,null,null,LocalizeText('trading.items.too_many_items.title'));}};const getLockIcon=accepts=>{const iconName=accepts?'locked':'open';return/*#__PURE__*/_jsx(\"i\",{className:'mt-auto pb-5 icon icon-lock-'+iconName});};useEffect(()=>{if(tradeState!==TradeState.TRADING_STATE_COUNTDOWN)return;setCountdownTick(3);const interval=setInterval(()=>{setCountdownTick(prevValue=>{const newValue=prevValue-1;if(newValue===0)clearInterval(interval);return newValue;});},1000);return()=>clearInterval(interval);},[tradeState,setTradeState]);useEffect(()=>{if(countdownTick!==0)return;setTradeState(TradeState.TRADING_STATE_CONFIRMING);},[countdownTick,setTradeState]);if(tradeState===TradeState.TRADING_STATE_READY||!ownUser||!otherUser)return null;return/*#__PURE__*/_jsxs(Column,{children:[/*#__PURE__*/_jsx(Flex,{children:/*#__PURE__*/_jsxs(Column,{size:4,fullWidth:true,overflow:\"hidden\",className:\"trading-inventory\",children:[/*#__PURE__*/_jsx(InventoryFurnitureSearchView,{groupItems:groupItems,setGroupItems:setFilteredGroupItems}),/*#__PURE__*/_jsxs(Flex,{column:true,fullHeight:true,fullWidth:true,justifyContent:\"between\",overflow:\"hidden\",gap:2,children:[/*#__PURE__*/_jsx(AutoGrid,{columnCount:3,children:filteredGroupItems&&filteredGroupItems.length>0&&filteredGroupItems.map((item,index)=>{const count=item.getUnlockedCount();return/*#__PURE__*/_jsx(LayoutGridItem,{className:!count?'opacity-0-5 ':'',itemImage:item.iconUrl,itemCount:count,itemActive:groupItem===item,itemUniqueNumber:item.stuffData.uniqueNumber,onClick:event=>count&&setGroupItem(item),children:count>0&&groupItem===item&&/*#__PURE__*/_jsx(Button,{position:\"absolute\",variant:\"success\",className:\"trade-button bottom-1 end-1\",onClick:event=>attemptItemOffer(1),children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:\"chevron-right\"})})},index);})}),/*#__PURE__*/_jsx(Base,{fullWidth:true,className:\"badge bg-muted\",children:groupItem?groupItem.name:LocalizeText('catalog_selectproduct')})]})]})}),/*#__PURE__*/_jsxs(Column,{fullWidth:true,size:8,overflow:\"hidden\",className:\"trade-bg p-2\",children:[/*#__PURE__*/_jsxs(Grid,{overflow:\"hidden\",children:[/*#__PURE__*/_jsxs(Column,{size:4,overflow:\"hidden\",children:[/*#__PURE__*/_jsx(Flex,{justifyContent:\"between\",alignItems:\"center\",children:/*#__PURE__*/_jsxs(Text,{children:[LocalizeText('inventory.trading.you'),\" \",LocalizeText('inventory.trading.areoffering'),\":\"]})}),/*#__PURE__*/_jsx(AutoGrid,{columnCount:3,children:Array.from(Array(MAX_ITEMS_TO_TRADE),(e,i)=>{const item=ownUser.userItems.getWithIndex(i)||null;if(!item)return/*#__PURE__*/_jsx(LayoutGridItem,{},i);return/*#__PURE__*/_jsx(LayoutGridItem,{itemActive:ownGroupItem===item,itemImage:item.iconUrl,itemCount:item.getTotalCount(),itemUniqueNumber:item.stuffData.uniqueNumber,onClick:event=>setOwnGroupItem(item),children:ownGroupItem===item&&/*#__PURE__*/_jsx(Button,{position:\"absolute\",variant:\"danger\",className:\"trade-button bottom-1 start-1\",onClick:event=>removeItem(item),children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:\"chevron-left\"})})},i);})}),/*#__PURE__*/_jsx(Base,{fullWidth:true,className:\"badge bg-muted\",children:ownGroupItem?ownGroupItem.name:LocalizeText('catalog_selectproduct')})]}),getLockIcon(ownUser.accepts),/*#__PURE__*/_jsxs(Column,{size:4,overflow:\"hidden\",children:[/*#__PURE__*/_jsx(Flex,{justifyContent:\"between\",alignItems:\"center\",children:/*#__PURE__*/_jsxs(Text,{children:[otherUser.userName,\" \",LocalizeText('inventory.trading.isoffering'),\":\"]})}),/*#__PURE__*/_jsx(AutoGrid,{columnCount:3,children:Array.from(Array(MAX_ITEMS_TO_TRADE),(e,i)=>{const item=otherUser.userItems.getWithIndex(i)||null;if(!item)return/*#__PURE__*/_jsx(LayoutGridItem,{},i);return/*#__PURE__*/_jsx(LayoutGridItem,{itemActive:otherGroupItem===item,itemImage:item.iconUrl,itemCount:item.getTotalCount(),itemUniqueNumber:item.stuffData.uniqueNumber,onClick:event=>setOtherGroupItem(item)},i);})}),/*#__PURE__*/_jsx(Base,{fullWidth:true,className:\"badge bg-muted w-100\",children:otherGroupItem?otherGroupItem.name:LocalizeText('catalog_selectproduct')})]}),getLockIcon(otherUser.accepts)]}),/*#__PURE__*/_jsxs(Flex,{grow:true,justifyContent:\"between\",children:[/*#__PURE__*/_jsx(Button,{variant:\"danger\",onClick:cancelTrade,children:LocalizeText('generic.cancel')}),tradeState===TradeState.TRADING_STATE_READY&&/*#__PURE__*/_jsx(Button,{variant:\"secondary\",disabled:!ownUser.itemCount&&!otherUser.itemCount,onClick:progressTrade,children:LocalizeText('inventory.trading.accept')}),tradeState===TradeState.TRADING_STATE_RUNNING&&/*#__PURE__*/_jsx(Button,{variant:\"secondary\",disabled:!ownUser.itemCount&&!otherUser.itemCount,onClick:progressTrade,children:LocalizeText(ownUser.accepts?'inventory.trading.modify':'inventory.trading.accept')}),tradeState===TradeState.TRADING_STATE_COUNTDOWN&&/*#__PURE__*/_jsx(Button,{variant:\"secondary\",disabled:true,children:LocalizeText('inventory.trading.countdown',['counter'],[countdownTick.toString()])}),tradeState===TradeState.TRADING_STATE_CONFIRMING&&/*#__PURE__*/_jsx(Button,{variant:\"secondary\",onClick:progressTrade,children:LocalizeText('inventory.trading.button.restore')}),tradeState===TradeState.TRADING_STATE_CONFIRMED&&/*#__PURE__*/_jsx(Button,{variant:\"secondary\",children:LocalizeText('inventory.trading.info.waiting')})]})]})]});};","map":null,"metadata":{},"sourceType":"module"}