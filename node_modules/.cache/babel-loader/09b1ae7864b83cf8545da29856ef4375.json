{"ast":null,"code":"import{NitroLogger}from'../../core';import{NitroManager}from'../../core/common/NitroManager';import{NitroEvent}from'../../core/events/NitroEvent';import{Nitro}from'../Nitro';import{FigureDataContainer}from'../utils/FigureDataContainer';import{AssetAliasCollection}from'./alias/AssetAliasCollection';import{AvatarAssetDownloadManager}from'./AvatarAssetDownloadManager';import{AvatarFigureContainer}from'./AvatarFigureContainer';import{AvatarImage}from'./AvatarImage';import{AvatarStructure}from'./AvatarStructure';import{HabboAvatarAnimations}from'./data/HabboAvatarAnimations';import{HabboAvatarGeometry}from'./data/HabboAvatarGeometry';import{HabboAvatarPartSets}from'./data/HabboAvatarPartSets';import{EffectAssetDownloadManager}from'./EffectAssetDownloadManager';import{AvatarSetType}from'./enum/AvatarSetType';import{AvatarRenderEvent}from'./events/AvatarRenderEvent';import{PlaceHolderAvatarImage}from'./PlaceHolderAvatarImage';import{AvatarStructureDownload}from'./structure/AvatarStructureDownload';export class AvatarRenderManager extends NitroManager{constructor(){super();this._aliasCollection=void 0;this._structure=void 0;this._avatarAssetDownloadManager=void 0;this._effectAssetDownloadManager=void 0;this._placeHolderFigure=void 0;this._figureMapReady=void 0;this._effectMapReady=void 0;this._actionsReady=void 0;this._structureReady=void 0;this._geometryReady=void 0;this._partSetsReady=void 0;this._animationsReady=void 0;this._isReady=void 0;this._structure=null;this._avatarAssetDownloadManager=null;this._placeHolderFigure=null;this._figureMapReady=false;this._effectMapReady=false;this._actionsReady=false;this._geometryReady=false;this._partSetsReady=false;this._animationsReady=false;this._isReady=false;this.onAvatarAssetDownloaderReady=this.onAvatarAssetDownloaderReady.bind(this);this.onAvatarAssetDownloaded=this.onAvatarAssetDownloaded.bind(this);this.onEffectAssetDownloaderReady=this.onEffectAssetDownloaderReady.bind(this);this.onEffectAssetDownloaded=this.onEffectAssetDownloaded.bind(this);this.onAvatarStructureDownloadDone=this.onAvatarStructureDownloadDone.bind(this);}onInit(){this._structure=new AvatarStructure(this);this.loadGeometry();this.loadPartSets();this.loadActions();this.loadAnimations();this.loadFigureData();this._aliasCollection=new AssetAliasCollection(this,Nitro.instance.core.asset);this._aliasCollection.init();if(!this._avatarAssetDownloadManager){this._avatarAssetDownloadManager=new AvatarAssetDownloadManager(Nitro.instance.core.asset,this._structure);this._avatarAssetDownloadManager.addEventListener(AvatarAssetDownloadManager.DOWNLOADER_READY,this.onAvatarAssetDownloaderReady);this._avatarAssetDownloadManager.addEventListener(AvatarAssetDownloadManager.LIBRARY_LOADED,this.onAvatarAssetDownloaded);}if(!this._effectAssetDownloadManager){this._effectAssetDownloadManager=new EffectAssetDownloadManager(Nitro.instance.core.asset,this._structure);this._effectAssetDownloadManager.addEventListener(EffectAssetDownloadManager.DOWNLOADER_READY,this.onEffectAssetDownloaderReady);this._effectAssetDownloadManager.addEventListener(EffectAssetDownloadManager.LIBRARY_LOADED,this.onEffectAssetDownloaded);}this.checkReady();}onDispose(){if(this._avatarAssetDownloadManager){this._avatarAssetDownloadManager.removeEventListener(AvatarAssetDownloadManager.DOWNLOADER_READY,this.onAvatarAssetDownloaderReady);this._avatarAssetDownloadManager.removeEventListener(AvatarAssetDownloadManager.LIBRARY_LOADED,this.onAvatarAssetDownloaded);}if(this._effectAssetDownloadManager){this._effectAssetDownloadManager.removeEventListener(EffectAssetDownloadManager.DOWNLOADER_READY,this.onEffectAssetDownloaderReady);this._effectAssetDownloadManager.removeEventListener(EffectAssetDownloadManager.LIBRARY_LOADED,this.onEffectAssetDownloaded);}}loadGeometry(){if(!this._structure)return;this._structure.initGeometry(HabboAvatarGeometry.geometry);this._geometryReady=true;this.checkReady();}loadPartSets(){if(!this._structure)return;this._structure.initPartSets(HabboAvatarPartSets.partSets);this._partSetsReady=true;this.checkReady();}loadActions(){const defaultActions=Nitro.instance.getConfiguration('avatar.default.actions');if(defaultActions)this._structure.initActions(Nitro.instance.core.asset,defaultActions);const request=new XMLHttpRequest();try{request.open('GET',Nitro.instance.getConfiguration('avatar.actions.url'));request.send();request.onloadend=e=>{if(!this._structure)return;this._structure.updateActions(JSON.parse(request.responseText));this._actionsReady=true;this.checkReady();};request.onerror=e=>{throw new Error('invalid_avatar_actions');};}catch(e){this.logger.error(e);}}loadAnimations(){if(!this._structure)return;this._structure.initAnimation(HabboAvatarAnimations.animations);this._animationsReady=true;this.checkReady();}loadFigureData(){const defaultFigureData=Nitro.instance.getConfiguration('avatar.default.figuredata');if(!defaultFigureData||typeof defaultFigureData==='string'){NitroLogger.log('XML figuredata is no longer supported.');return;}if(this._structure)this._structure.initFigureData(defaultFigureData);const structureDownloader=new AvatarStructureDownload(Nitro.instance.getConfiguration('avatar.figuredata.url'),this._structure.figureData);structureDownloader.addEventListener(AvatarStructureDownload.AVATAR_STRUCTURE_DONE,this.onAvatarStructureDownloadDone);}onAvatarStructureDownloadDone(event){this._structureReady=true;this._structure.init();this.checkReady();}onAvatarAssetDownloaderReady(event){if(!event)return;this._figureMapReady=true;this.checkReady();}onAvatarAssetDownloaded(event){if(!event)return;this._aliasCollection.reset();}onEffectAssetDownloaderReady(event){if(!event)return;this._effectMapReady=true;this.checkReady();}onEffectAssetDownloaded(event){if(!event)return;this._aliasCollection.reset();}checkReady(){if(this._isReady)return;if(!this._geometryReady||!this._partSetsReady||!this._actionsReady||!this._animationsReady||!this._figureMapReady||!this._effectMapReady||!this._structureReady)return;this._isReady=true;if(this.events)this.events.dispatchEvent(new NitroEvent(AvatarRenderEvent.AVATAR_RENDER_READY));}createFigureContainer(figure){return new AvatarFigureContainer(figure);}isFigureContainerReady(container){if(!this._avatarAssetDownloadManager)return false;return this._avatarAssetDownloadManager.isAvatarFigureContainerReady(container);}createAvatarImage(figure,size,gender){let listener=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;let effectListener=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(!this._structure||!this._avatarAssetDownloadManager)return null;const figureContainer=new AvatarFigureContainer(figure);if(gender)this.validateAvatarFigure(figureContainer,gender);if(this._avatarAssetDownloadManager.isAvatarFigureContainerReady(figureContainer)){return new AvatarImage(this._structure,this._aliasCollection,figureContainer,size,this._effectAssetDownloadManager,effectListener);}if(!this._placeHolderFigure)this._placeHolderFigure=new AvatarFigureContainer(AvatarRenderManager.DEFAULT_FIGURE);this._avatarAssetDownloadManager.downloadAvatarFigure(figureContainer,listener);return new PlaceHolderAvatarImage(this._structure,this._aliasCollection,this._placeHolderFigure,size,this._effectAssetDownloadManager);}downloadAvatarFigure(container,listener){if(!this._avatarAssetDownloadManager)return;this._avatarAssetDownloadManager.downloadAvatarFigure(container,listener);}validateAvatarFigure(container,gender){let isValid=false;const typeIds=this._structure.getMandatorySetTypeIds(gender,2);if(typeIds){const figureData=this._structure.figureData;for(const id of typeIds){if(!container.hasPartType(id)){const figurePartSet=this._structure.getDefaultPartSet(id,gender);if(figurePartSet){container.updatePart(id,figurePartSet.id,[0]);isValid=true;}}else{const setType=figureData.getSetType(id);if(setType){const figurePartSet=setType.getPartSet(container.getPartSetId(id));if(!figurePartSet){const partSet=this._structure.getDefaultPartSet(id,gender);if(partSet){container.updatePart(id,partSet.id,[0]);isValid=true;}}}}}}return!isValid;}getFigureClubLevel(container,gender){let searchParts=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!this._structure)return 0;const figureData=this._structure.figureData;const parts=Array.from(container.getPartTypeIds());let clubLevel=0;for(const part of parts){const set=figureData.getSetType(part);if(!set)continue;const setId=container.getPartSetId(part);const partSet=set.getPartSet(setId);if(partSet){clubLevel=Math.max(partSet.clubLevel,clubLevel);const palette=figureData.getPalette(set.paletteID);const colors=container.getPartColorIds(part);for(const colorId of colors){const color=palette.getColor(colorId);if(!color)continue;clubLevel=Math.max(color.clubLevel,clubLevel);}}}if(!searchParts)searchParts=this._structure.getBodyPartsUnordered(AvatarSetType.FULL);for(const part of searchParts){const set=figureData.getSetType(part);if(!set)continue;if(parts.indexOf(part)===-1)clubLevel=Math.max(set.optionalFromClubLevel(gender),clubLevel);}return clubLevel;}isValidFigureSetForGender(setId,gender){const structure=this.structureData;const partSet=structure.getFigurePartSet(setId);return!!(partSet&&(partSet.gender.toUpperCase()==='U'||partSet.gender.toUpperCase()===gender.toUpperCase()));}getFigureStringWithFigureIds(k,_arg_2,_arg_3){const container=new FigureDataContainer();container.loadAvatarData(k,_arg_2);const partSets=this.resolveFigureSets(_arg_3);for(const partSet of partSets){container.savePartData(partSet.type,partSet.id,container.getColourIds(partSet.type));}return container.getFigureString();}resolveFigureSets(k){const structure=this.structureData;const partSets=[];for(const _local_4 of k){const partSet=structure.getFigurePartSet(_local_4);if(partSet)partSets.push(partSet);}return partSets;}getMandatoryAvatarPartSetIds(k,_arg_2){if(!this._structure)return null;return this._structure.getMandatorySetTypeIds(k,_arg_2);}getAssetByName(name){return this._aliasCollection.getAsset(name);}get assets(){return Nitro.instance.core.asset;}get isReady(){return this._isReady;}get structure(){return this._structure;}get structureData(){if(this._structure)return this._structure.figureData;return null;}get downloadManager(){return this._avatarAssetDownloadManager;}}AvatarRenderManager.DEFAULT_FIGURE='hd-99999-99999';","map":null,"metadata":{},"sourceType":"module"}