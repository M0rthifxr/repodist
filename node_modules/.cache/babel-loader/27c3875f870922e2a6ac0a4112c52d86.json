{"ast":null,"code":"import{GuideOnDutyStatusMessageEvent,GuideSessionAttachedMessageEvent,GuideSessionDetachedMessageEvent,GuideSessionEndedMessageEvent,GuideSessionInvitedToGuideRoomMessageEvent,GuideSessionMessageMessageEvent,GuideSessionOnDutyUpdateMessageComposer,GuideSessionPartnerIsTypingMessageEvent,GuideSessionStartedMessageEvent,PerkAllowancesMessageEvent,PerkEnum}from'@nitrots/nitro-renderer';import{useCallback,useEffect,useState}from'react';import{AddEventLinkTracker,GetConfiguration,GetSessionDataManager,LocalizeText,RemoveLinkEventTracker,SendMessageComposer}from'../../api';import{NitroCardContentView,NitroCardHeaderView,NitroCardView}from'../../common';import{GuideToolEvent,NotificationAlertEvent}from'../../events';import{DispatchUiEvent,UseMessageEventHook,UseUiEvent}from'../../hooks';import{GuideSessionState}from'./common/GuideSessionState';import{GuideToolMessage}from'./common/GuideToolMessage';import{GuideToolMessageGroup}from'./common/GuideToolMessageGroup';import{GuideToolAcceptView}from'./views/GuideToolAcceptView';import{GuideToolMenuView}from'./views/GuideToolMenuView';import{GuideToolOngoingView}from'./views/GuideToolOngoingView';import{GuideToolUserCreateRequestView}from'./views/GuideToolUserCreateRequestView';import{GuideToolUserFeedbackView}from'./views/GuideToolUserFeedbackView';import{GuideToolUserPendingView}from'./views/GuideToolUserPendingView';import{GuideToolUserThanksView}from'./views/GuideToolUserThanksView';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export const GuideToolView=props=>{const[isVisible,setIsVisible]=useState(false);const[headerText,setHeaderText]=useState(LocalizeText('guide.help.guide.tool.title'));const[noCloseButton,setNoCloseButton]=useState(false);const[sessionState,setSessionState]=useState(GuideSessionState.GUIDE_TOOL_MENU);const[isOnDuty,setIsOnDuty]=useState(false);const[isHandlingBullyReports,setIsHandlingBullyReports]=useState(false);const[isHandlingGuideRequests,setIsHandlingGuideRequests]=useState(false);const[isHandlingHelpRequests,setIsHandlingHelpRequests]=useState(false);const[helpersOnDuty,setHelpersOnDuty]=useState(0);const[guidesOnDuty,setGuidesOnDuty]=useState(0);const[guardiansOnDuty,setGuardiansOnDuty]=useState(0);const[userRequest,setUserRequest]=useState('');const[helpRequestDescription,setHelpRequestDescription]=useState(null);const[helpRequestAverageTime,setHelpRequestAverageTime]=useState(0);const[ongoingUserId,setOngoingUserId]=useState(0);const[ongoingUsername,setOngoingUsername]=useState(null);const[ongoingFigure,setOngoingFigure]=useState(null);const[ongoingIsTyping,setOngoingIsTyping]=useState(false);const[ongoingMessageGroups,setOngoingMessageGroups]=useState([]);const updateSessionState=useCallback((newState,replacement)=>{switch(newState){case GuideSessionState.GUIDE_TOOL_MENU:setHeaderText(LocalizeText('guide.help.guide.tool.title'));setNoCloseButton(false);break;case GuideSessionState.GUIDE_ACCEPT:setHeaderText(LocalizeText('guide.help.request.guide.accept.title'));setNoCloseButton(true);break;case GuideSessionState.GUIDE_ONGOING:setHeaderText(LocalizeText('guide.help.request.guide.ongoing.title',['name'],[replacement]));setNoCloseButton(true);break;case GuideSessionState.USER_CREATE:setHeaderText(LocalizeText('guide.help.request.user.create.title'));setNoCloseButton(false);break;case GuideSessionState.USER_PENDING:setHeaderText(LocalizeText('guide.help.request.user.pending.title'));setNoCloseButton(true);break;case GuideSessionState.USER_ONGOING:setHeaderText(LocalizeText('guide.help.request.user.ongoing.title',['name'],[replacement]));setNoCloseButton(true);break;case GuideSessionState.USER_FEEDBACK:setHeaderText(LocalizeText('guide.help.request.user.feedback.title'));setNoCloseButton(true);break;case GuideSessionState.USER_THANKS:setHeaderText(LocalizeText('guide.help.request.user.thanks.title'));setNoCloseButton(false);break;}setSessionState(newState);setIsVisible(true);},[]);const onGuideToolEvent=useCallback(event=>{switch(event.type){case GuideToolEvent.SHOW_GUIDE_TOOL:setIsVisible(true);return;case GuideToolEvent.HIDE_GUIDE_TOOL:setIsVisible(false);return;case GuideToolEvent.TOGGLE_GUIDE_TOOL:setIsVisible(value=>!value);return;case GuideToolEvent.CREATE_HELP_REQUEST:updateSessionState(GuideSessionState.USER_CREATE);return;}},[updateSessionState]);UseUiEvent(GuideToolEvent.SHOW_GUIDE_TOOL,onGuideToolEvent);UseUiEvent(GuideToolEvent.HIDE_GUIDE_TOOL,onGuideToolEvent);UseUiEvent(GuideToolEvent.TOGGLE_GUIDE_TOOL,onGuideToolEvent);UseUiEvent(GuideToolEvent.CREATE_HELP_REQUEST,onGuideToolEvent);const onPerkAllowancesMessageEvent=useCallback(event=>{const parser=event.getParser();if(!parser.isAllowed(PerkEnum.USE_GUIDE_TOOL)&&isOnDuty){setIsOnDuty(false);SendMessageComposer(new GuideSessionOnDutyUpdateMessageComposer(false,false,false,false));}},[isOnDuty,setIsOnDuty]);UseMessageEventHook(PerkAllowancesMessageEvent,onPerkAllowancesMessageEvent);const onGuideOnDutyStatusMessageEvent=useCallback(event=>{const parser=event.getParser();setIsOnDuty(parser.onDuty);setGuidesOnDuty(parser.guidesOnDuty);setHelpersOnDuty(parser.helpersOnDuty);setGuardiansOnDuty(parser.guardiansOnDuty);},[setIsOnDuty,setHelpersOnDuty,setGuidesOnDuty,setGuardiansOnDuty]);UseMessageEventHook(GuideOnDutyStatusMessageEvent,onGuideOnDutyStatusMessageEvent);const onGuideSessionAttachedMessageEvent=useCallback(event=>{const parser=event.getParser();setHelpRequestDescription(parser.helpRequestDescription);setHelpRequestAverageTime(parser.roleSpecificWaitTime);if(parser.asGuide&&isOnDuty)updateSessionState(GuideSessionState.GUIDE_ACCEPT);if(!parser.asGuide)updateSessionState(GuideSessionState.USER_PENDING);},[isOnDuty,updateSessionState]);UseMessageEventHook(GuideSessionAttachedMessageEvent,onGuideSessionAttachedMessageEvent);const onGuideSessionStartedMessageEvent=useCallback(event=>{const parser=event.getParser();if(isOnDuty){setOngoingUserId(parser.requesterUserId);setOngoingUsername(parser.requesterName);setOngoingFigure(parser.requesterFigure);updateSessionState(GuideSessionState.GUIDE_ONGOING,parser.requesterName);}else{setOngoingUserId(parser.guideUserId);setOngoingUsername(parser.guideName);setOngoingFigure(parser.guideFigure);updateSessionState(GuideSessionState.USER_ONGOING,parser.guideName);}},[isOnDuty,updateSessionState]);UseMessageEventHook(GuideSessionStartedMessageEvent,onGuideSessionStartedMessageEvent);const onGuideSessionPartnerIsTypingMessageEvent=useCallback(event=>{const parser=event.getParser();setOngoingIsTyping(parser.isTyping);},[]);UseMessageEventHook(GuideSessionPartnerIsTypingMessageEvent,onGuideSessionPartnerIsTypingMessageEvent);const onGuideSessionMessageMessageEvent=useCallback(event=>{const parser=event.getParser();const messageGroups=[...ongoingMessageGroups];let lastGroup=messageGroups[messageGroups.length-1];if(!lastGroup||lastGroup.userId!==parser.senderId){lastGroup=new GuideToolMessageGroup(parser.senderId);messageGroups.push(lastGroup);}lastGroup.addChat(new GuideToolMessage(parser.chatMessage));setOngoingMessageGroups(messageGroups);},[ongoingMessageGroups]);UseMessageEventHook(GuideSessionMessageMessageEvent,onGuideSessionMessageMessageEvent);const onGuideSessionInvitedToGuideRoomMessageEvent=useCallback(event=>{const parser=event.getParser();const messageGroups=[...ongoingMessageGroups];let lastGroup=messageGroups[messageGroups.length-1];const guideId=isOnDuty?GetSessionDataManager().userId:ongoingUserId;if(!lastGroup||lastGroup.userId!==guideId){lastGroup=new GuideToolMessageGroup(guideId);messageGroups.push(lastGroup);}lastGroup.addChat(new GuideToolMessage(parser.roomName,parser.roomId));setOngoingMessageGroups(messageGroups);},[isOnDuty,ongoingMessageGroups,ongoingUserId]);UseMessageEventHook(GuideSessionInvitedToGuideRoomMessageEvent,onGuideSessionInvitedToGuideRoomMessageEvent);const onGuideSessionEndedMessageEvent=useCallback(event=>{if(isOnDuty){setOngoingUserId(0);setOngoingUsername(null);setOngoingFigure(null);setOngoingIsTyping(false);setOngoingMessageGroups([]);updateSessionState(GuideSessionState.GUIDE_TOOL_MENU);}else{updateSessionState(GuideSessionState.USER_FEEDBACK);}},[isOnDuty,updateSessionState]);UseMessageEventHook(GuideSessionEndedMessageEvent,onGuideSessionEndedMessageEvent);const onGuideSessionDetachedMessageEvent=useCallback(event=>{setOngoingUserId(0);setOngoingUsername(null);setOngoingFigure(null);setOngoingIsTyping(false);setOngoingMessageGroups([]);if(isOnDuty){updateSessionState(GuideSessionState.GUIDE_TOOL_MENU);}else{updateSessionState(GuideSessionState.USER_THANKS);}},[isOnDuty,updateSessionState]);UseMessageEventHook(GuideSessionDetachedMessageEvent,onGuideSessionDetachedMessageEvent);const linkReceived=useCallback(url=>{const parts=url.split('/');if(parts.length<2)return;switch(parts[1]){case'tour'://Create Tour Request\nreturn;}},[]);useEffect(()=>{const linkTracker={linkReceived,eventUrlPrefix:'help/'};AddEventLinkTracker(linkTracker);return()=>RemoveLinkEventTracker(linkTracker);},[linkReceived]);const processAction=useCallback(action=>{switch(action){case'close':setIsVisible(false);setUserRequest('');setSessionState(GuideSessionState.GUIDE_TOOL_MENU);return;case'toggle_duty':if(!isHandlingBullyReports&&!isHandlingGuideRequests&&!isHandlingHelpRequests){DispatchUiEvent(new NotificationAlertEvent([LocalizeText('guide.help.guide.tool.noqueueselected.message')],null,null,null,LocalizeText('guide.help.guide.tool.noqueueselected.caption'),null));return;}setIsOnDuty(v=>{SendMessageComposer(new GuideSessionOnDutyUpdateMessageComposer(!v,v?false:isHandlingGuideRequests,v?false:isHandlingHelpRequests,v?false:isHandlingBullyReports));return!v;});return;case'forum_link':const url=GetConfiguration('group.homepage.url','').replace('%groupid%',GetConfiguration('guide.help.alpha.groupid','0'));window.open(url);return;}},[isHandlingBullyReports,isHandlingGuideRequests,isHandlingHelpRequests]);if(!isVisible)return null;return/*#__PURE__*/_jsxs(NitroCardView,{className:\"nitro-guide-tool\",theme:\"primary\",children:[/*#__PURE__*/_jsx(NitroCardHeaderView,{headerText:headerText,onCloseClick:event=>processAction('close'),noCloseButton:noCloseButton}),/*#__PURE__*/_jsxs(NitroCardContentView,{className:\"text-black\",children:[sessionState===GuideSessionState.GUIDE_TOOL_MENU&&/*#__PURE__*/_jsx(GuideToolMenuView,{isOnDuty:isOnDuty,isHandlingGuideRequests:isHandlingGuideRequests,setIsHandlingGuideRequests:setIsHandlingGuideRequests,isHandlingHelpRequests:isHandlingHelpRequests,setIsHandlingHelpRequests:setIsHandlingHelpRequests,isHandlingBullyReports:isHandlingBullyReports,setIsHandlingBullyReports:setIsHandlingBullyReports,guidesOnDuty:guidesOnDuty,helpersOnDuty:helpersOnDuty,guardiansOnDuty:guardiansOnDuty,processAction:processAction}),sessionState===GuideSessionState.GUIDE_ACCEPT&&/*#__PURE__*/_jsx(GuideToolAcceptView,{helpRequestDescription:helpRequestDescription,helpRequestAverageTime:helpRequestAverageTime}),[GuideSessionState.GUIDE_ONGOING,GuideSessionState.USER_ONGOING].includes(sessionState)&&/*#__PURE__*/_jsx(GuideToolOngoingView,{isGuide:isOnDuty,userId:ongoingUserId,userName:ongoingUsername,userFigure:ongoingFigure,isTyping:ongoingIsTyping,messageGroups:ongoingMessageGroups}),sessionState===GuideSessionState.USER_CREATE&&/*#__PURE__*/_jsx(GuideToolUserCreateRequestView,{userRequest:userRequest,setUserRequest:setUserRequest}),sessionState===GuideSessionState.USER_PENDING&&/*#__PURE__*/_jsx(GuideToolUserPendingView,{helpRequestDescription:helpRequestDescription,helpRequestAverageTime:helpRequestAverageTime}),sessionState===GuideSessionState.USER_FEEDBACK&&/*#__PURE__*/_jsx(GuideToolUserFeedbackView,{userName:ongoingUsername}),sessionState===GuideSessionState.USER_THANKS&&/*#__PURE__*/_jsx(GuideToolUserThanksView,{})]})]});};","map":null,"metadata":{},"sourceType":"module"}