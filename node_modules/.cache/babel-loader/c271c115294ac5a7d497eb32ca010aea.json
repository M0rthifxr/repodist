{"ast":null,"code":"import{FontAwesomeIcon}from'@fortawesome/react-fontawesome';import{ApproveNameMessageComposer,ApproveNameMessageEvent,ColorConverter,GetSellablePetPalettesComposer,PurchaseFromCatalogComposer}from'@nitrots/nitro-renderer';import{useCallback,useEffect,useMemo,useState}from'react';import{GetPetAvailableColors,GetPetIndexFromLocalization,LocalizeText,SendMessageComposer}from'../../../../../../api';import{AutoGrid,Base,Button,Column,Flex,LayoutGridItem,LayoutPetImageView,Text}from'../../../../../../common';import{CatalogPurchaseFailureEvent}from'../../../../../../events';import{DispatchUiEvent,useCatalog,UseMessageEventHook}from'../../../../../../hooks';import{CatalogAddOnBadgeWidgetView}from'../../widgets/CatalogAddOnBadgeWidgetView';import{CatalogPurchaseWidgetView}from'../../widgets/CatalogPurchaseWidgetView';import{CatalogTotalPriceWidget}from'../../widgets/CatalogTotalPriceWidget';import{CatalogViewProductWidgetView}from'../../widgets/CatalogViewProductWidgetView';import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export const CatalogLayoutPetView=props=>{const{page=null}=props;const[petIndex,setPetIndex]=useState(-1);const[sellablePalettes,setSellablePalettes]=useState([]);const[selectedPaletteIndex,setSelectedPaletteIndex]=useState(-1);const[sellableColors,setSellableColors]=useState([]);const[selectedColorIndex,setSelectedColorIndex]=useState(-1);const[colorsShowing,setColorsShowing]=useState(false);const[petName,setPetName]=useState('');const[approvalPending,setApprovalPending]=useState(true);const[approvalResult,setApprovalResult]=useState(-1);const{currentOffer=null,setCurrentOffer=null,setPurchaseOptions=null,catalogOptions=null,roomPreviewer=null}=useCatalog();const{petPalettes=null}=catalogOptions;const getColor=useMemo(()=>{if(!sellableColors.length||selectedColorIndex===-1)return 0xFFFFFF;return sellableColors[selectedColorIndex][0];},[sellableColors,selectedColorIndex]);const petBreedName=useMemo(()=>{if(petIndex===-1||!sellablePalettes.length||selectedPaletteIndex===-1)return'';return LocalizeText(`pet.breed.${petIndex}.${sellablePalettes[selectedPaletteIndex].breedId}`);},[petIndex,sellablePalettes,selectedPaletteIndex]);const petPurchaseString=useMemo(()=>{if(!sellablePalettes.length||selectedPaletteIndex===-1)return'';const paletteId=sellablePalettes[selectedPaletteIndex].paletteId;let color=0xFFFFFF;if(petIndex<=7){if(selectedColorIndex===-1)return'';color=sellableColors[selectedColorIndex][0];}let colorString=color.toString(16).toUpperCase();while(colorString.length<6)colorString='0'+colorString;return`${paletteId}\\n${colorString}`;},[sellablePalettes,selectedPaletteIndex,petIndex,sellableColors,selectedColorIndex]);const validationErrorMessage=useMemo(()=>{let key='';switch(approvalResult){case 1:key='catalog.alert.petname.long';break;case 2:key='catalog.alert.petname.short';break;case 3:key='catalog.alert.petname.chars';break;case 4:key='catalog.alert.petname.bobba';break;}if(!key||!key.length)return'';return LocalizeText(key);},[approvalResult]);const purchasePet=useCallback(()=>{if(approvalResult===-1){SendMessageComposer(new ApproveNameMessageComposer(petName,1));return;}if(approvalResult===0){SendMessageComposer(new PurchaseFromCatalogComposer(page.pageId,currentOffer.offerId,`${petName}\\n${petPurchaseString}`,1));return;}},[page,currentOffer,petName,petPurchaseString,approvalResult]);const onApproveNameMessageEvent=useCallback(event=>{const parser=event.getParser();setApprovalResult(parser.result);if(parser.result===0)purchasePet();else DispatchUiEvent(new CatalogPurchaseFailureEvent(-1));},[purchasePet]);UseMessageEventHook(ApproveNameMessageEvent,onApproveNameMessageEvent);useEffect(()=>{if(!page||!page.offers.length)return;const offer=page.offers[0];setCurrentOffer(offer);setPetIndex(GetPetIndexFromLocalization(offer.localizationId));setColorsShowing(false);},[page,setCurrentOffer]);useEffect(()=>{if(!currentOffer)return;const productData=currentOffer.product.productData;if(!productData)return;if(petPalettes){for(const paletteData of petPalettes){if(paletteData.breed!==productData.type)continue;const palettes=[];for(const palette of paletteData.palettes){if(!palette.sellable)continue;palettes.push(palette);}setSelectedPaletteIndex(palettes.length?0:-1);setSellablePalettes(palettes);return;}}setSelectedPaletteIndex(-1);setSellablePalettes([]);SendMessageComposer(new GetSellablePetPalettesComposer(productData.type));},[currentOffer,petPalettes]);useEffect(()=>{if(petIndex===-1)return;const colors=GetPetAvailableColors(petIndex,sellablePalettes);setSelectedColorIndex(colors.length?0:-1);setSellableColors(colors);},[petIndex,sellablePalettes]);useEffect(()=>{if(!roomPreviewer)return;roomPreviewer.reset(false);if(petIndex===-1||!sellablePalettes.length||selectedPaletteIndex===-1)return;let petFigureString=`${petIndex} ${sellablePalettes[selectedPaletteIndex].paletteId}`;if(petIndex<=7)petFigureString+=` ${getColor.toString(16)}`;roomPreviewer.addPetIntoRoom(petFigureString);},[roomPreviewer,petIndex,sellablePalettes,selectedPaletteIndex,getColor]);useEffect(()=>{setApprovalResult(-1);},[petName]);if(!currentOffer)return null;return/*#__PURE__*/_jsx(Column,{children:/*#__PURE__*/_jsxs(Column,{center:!currentOffer,size:5,overflow:\"hidden\",children:[!currentOffer&&/*#__PURE__*/_jsxs(_Fragment,{children:[!!page.localization.getImage(1)&&/*#__PURE__*/_jsx(\"img\",{alt:\"\",src:page.localization.getImage(1)}),/*#__PURE__*/_jsx(Text,{center:true,dangerouslySetInnerHTML:{__html:page.localization.getText(0)}})]}),currentOffer&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(Base,{position:\"relative\",overflow:\"hidden\",children:[/*#__PURE__*/_jsx(CatalogViewProductWidgetView,{}),/*#__PURE__*/_jsx(CatalogTotalPriceWidget,{className:\"credits-default-layout credits-bg py-1 px-2 bottom-1 end-1\",justifyContent:\"end\",alignItems:\"end\"}),/*#__PURE__*/_jsx(CatalogAddOnBadgeWidgetView,{position:\"absolute\",className:\"bg-muted rounded bottom-1 end-1\"}),petIndex>-1&&petIndex<=7&&/*#__PURE__*/_jsx(Button,{position:\"absolute\",className:\"bottom-1 start-1\",onClick:event=>setColorsShowing(!colorsShowing),children:/*#__PURE__*/_jsx(FontAwesomeIcon,{icon:\"fill-drip\"})})]}),/*#__PURE__*/_jsx(Column,{size:7,overflow:\"hidden\",children:/*#__PURE__*/_jsxs(AutoGrid,{className:\"grid-bg group-furni-picker p-2\",columnCount:7,children:[!colorsShowing&&sellablePalettes.length>0&&sellablePalettes.map((palette,index)=>{return/*#__PURE__*/_jsx(LayoutGridItem,{itemActive:selectedPaletteIndex===index,onClick:event=>setSelectedPaletteIndex(index),children:/*#__PURE__*/_jsx(LayoutPetImageView,{typeId:petIndex,paletteId:palette.paletteId,direction:2,headOnly:true})},index);}),colorsShowing&&sellableColors.length>0&&sellableColors.map((colorSet,index)=>/*#__PURE__*/_jsx(LayoutGridItem,{itemHighlight:true,itemActive:selectedColorIndex===index,itemColor:ColorConverter.int2rgb(colorSet[0]),className:\"clear-bg\",onClick:event=>setSelectedColorIndex(index)},index))]})}),/*#__PURE__*/_jsxs(Column,{grow:true,gap:1,children:[/*#__PURE__*/_jsx(Text,{truncate:true,children:petBreedName}),/*#__PURE__*/_jsxs(Column,{grow:true,gap:1,children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"form-control form-control-sm w-100\",placeholder:LocalizeText('widgets.petpackage.name.title'),value:petName,onChange:event=>setPetName(event.target.value)}),approvalResult>0&&/*#__PURE__*/_jsx(Base,{className:\"invalid-feedback d-block m-0\",children:validationErrorMessage})]}),/*#__PURE__*/_jsx(Flex,{gap:2,className:\"purchase-buttons align-items-end mt-2\",children:/*#__PURE__*/_jsx(CatalogPurchaseWidgetView,{purchaseCallback:purchasePet})})]})]})]})});};","map":null,"metadata":{},"sourceType":"module"}