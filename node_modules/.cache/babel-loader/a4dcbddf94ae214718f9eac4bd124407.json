{"ast":null,"code":"import{Loader,LoaderResource}from'@pixi/loaders';import{Spritesheet}from'@pixi/spritesheet';import{NitroBundle}from'../../core/asset/NitroBundle';import{NitroLogger}from'../../core/common/logger/NitroLogger';import{NitroEvent}from'../../core/events/NitroEvent';import{RoomContentLoadedEvent}from'../../room/events/RoomContentLoadedEvent';import{GraphicAssetCollection}from'../../room/object/visualization/utils/GraphicAssetCollection';import{GraphicAssetGifCollection}from'../../room/object/visualization/utils/GraphicAssetGifCollection';import{Nitro}from'../Nitro';import{FurnitureType}from'../session/furniture/FurnitureType';import{RoomObjectCategory}from'./object/RoomObjectCategory';import{RoomObjectUserType}from'./object/RoomObjectUserType';import{RoomObjectVariable}from'./object/RoomObjectVariable';import{RoomObjectVisualizationType}from'./object/RoomObjectVisualizationType';import{PetColorResult}from'./PetColorResult';export class RoomContentLoader{constructor(){this._logger=void 0;this._stateEvents=void 0;this._sessionDataManager=void 0;this._waitingForSessionDataManager=void 0;this._iconListener=void 0;this._collections=void 0;this._gifCollections=void 0;this._images=void 0;this._events=void 0;this._activeObjects=void 0;this._activeObjectTypes=void 0;this._activeObjectTypeIds=void 0;this._objectTypeAdUrls=void 0;this._wallItems=void 0;this._wallItemTypes=void 0;this._wallItemTypeIds=void 0;this._furniRevisions=void 0;this._pets=void 0;this._petColors=void 0;this._objectAliases=void 0;this._objectOriginalNames=void 0;this._pendingContentTypes=void 0;this._dataInitialized=void 0;this._logger=new NitroLogger(this.constructor.name);this._stateEvents=null;this._sessionDataManager=null;this._waitingForSessionDataManager=false;this._iconListener=null;this._collections=new Map();this._gifCollections=new Map();this._images=new Map();this._events=new Map();this._activeObjects={};this._activeObjectTypes=new Map();this._activeObjectTypeIds=new Map();this._objectTypeAdUrls=new Map();this._wallItems={};this._wallItemTypes=new Map();this._wallItemTypeIds=new Map();this._furniRevisions=new Map();this._pets={};this._petColors=new Map();this._objectAliases=new Map();this._objectOriginalNames=new Map();this._pendingContentTypes=[];this._dataInitialized=false;}initialize(events){this._stateEvents=events;this.setFurnitureData();for(const[index,name]of Nitro.instance.getConfiguration('pet.types').entries())this._pets[name]=index;}dispose(){}setSessionDataManager(sessionData){this._sessionDataManager=sessionData;if(this._waitingForSessionDataManager){this._waitingForSessionDataManager=false;this.setFurnitureData();}}loadFurnitureData(){this.setFurnitureData();}setFurnitureData(){if(!this._sessionDataManager){this._waitingForSessionDataManager=true;return;}const furnitureData=this._sessionDataManager.getAllFurnitureData(this);if(!furnitureData)return;this._sessionDataManager.removePendingFurniDataListener(this);this.processFurnitureData(furnitureData);this._stateEvents.dispatchEvent(new NitroEvent(RoomContentLoader.LOADER_READY));}processFurnitureData(furnitureData){if(!furnitureData)return;for(const furniture of furnitureData){if(!furniture)continue;const id=furniture.id;let className=furniture.className;if(furniture.hasIndexedColor)className=className+'*'+furniture.colorIndex;const revision=furniture.revision;const adUrl=furniture.adUrl;if(adUrl&&adUrl.length>0)this._objectTypeAdUrls.set(className,adUrl);let name=furniture.className;if(furniture.type===FurnitureType.FLOOR){this._activeObjectTypes.set(id,className);this._activeObjectTypeIds.set(className,id);if(!this._activeObjects[name])this._activeObjects[name]=1;}else if(furniture.type===FurnitureType.WALL){if(name==='post.it'){className='post_it';name='post_it';}if(name==='post.it.vd'){className='post_it_vd';name='post_id_vd';}this._wallItemTypes.set(id,className);this._wallItemTypeIds.set(className,id);if(!this._wallItems[name])this._wallItems[name]=1;}const existingRevision=this._furniRevisions.get(name);if(revision>existingRevision){this._furniRevisions.delete(name);this._furniRevisions.set(name,revision);}}}getFurnitureFloorNameForTypeId(typeId){const type=this._activeObjectTypes.get(typeId);return this.removeColorIndex(type);}getFurnitureWallNameForTypeId(typeId){let extra=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;let type=this._wallItemTypes.get(typeId);if(type==='poster'&&extra!==null)type=type+extra;return this.removeColorIndex(type);}getFurnitureFloorColorIndex(typeId){const type=this._activeObjectTypes.get(typeId);if(!type)return-1;return this.getColorIndexFromName(type);}getFurnitureWallColorIndex(typeId){const type=this._wallItemTypes.get(typeId);if(!type)return-1;return this.getColorIndexFromName(type);}getColorIndexFromName(name){if(!name)return-1;const index=name.indexOf('*');if(index===-1)return 0;return parseInt(name.substr(index+1));}removeColorIndex(name){if(!name)return null;const index=name.indexOf('*');if(index===-1)return name;return name.substr(0,index);}getRoomObjectAdUrl(type){const value=this._objectTypeAdUrls.get(type);if(!value)return'';return value;}getPetColorResult(petIndex,paletteIndex){const colorResults=this._petColors.get(petIndex);if(!colorResults)return null;return colorResults.get(paletteIndex);}getPetColorResultsForTag(petIndex,tagName){const colorResults=this._petColors.get(petIndex);const results=[];if(colorResults){for(const result of colorResults.values()){if(result.tag===tagName)results.push(result);}}return results;}getCollection(name){if(!name)return null;const existing=this._collections.get(name);if(!existing){const globalCollection=Nitro.instance.core.asset.getCollection(name);if(globalCollection){this._collections.set(name,globalCollection);return globalCollection;}return null;}return existing;}getGifCollection(name){if(!name)return null;return this._gifCollections.get(name)||null;}getImage(name){if(!name)return null;const existing=this._images.get(name);if(!existing)return null;const image=new Image();image.src=existing.src;return image;}addAssetToCollection(collectionName,assetName,texture){let override=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;const collection=this.getCollection(collectionName);if(!collection)return false;return collection.addAsset(assetName,texture,override,0,0,false,false);}createGifCollection(collectionName,textures,durations){if(!collectionName||!textures||!durations)return null;const collection=new GraphicAssetGifCollection(collectionName,textures,durations);this._gifCollections.set(collectionName,collection);return collection;}createCollection(data,spritesheet){if(!data||!spritesheet)return null;const collection=new GraphicAssetCollection(data,spritesheet);this._collections.set(collection.name,collection);const petIndex=this._pets[collection.name];if(petIndex!==undefined){const keys=collection.getPaletteNames();const palettes=new Map();for(const key of keys){const palette=collection.getPalette(key);const paletteData=data.palettes[key];const primaryColor=palette.primaryColor;const secondaryColor=palette.secondaryColor;const breed=paletteData.breed!==undefined?paletteData.breed:0;const tag=paletteData.colorTag!==undefined?paletteData.colorTag:-1;const master=paletteData.master!==undefined?paletteData.master:false;const layerTags=paletteData.tags!==undefined?paletteData.tags:[];palettes.set(parseInt(key),new PetColorResult(primaryColor,secondaryColor,breed,tag,key,master,layerTags));}this._petColors.set(petIndex,palettes);}}getPlaceholderName(type){const category=this.getCategoryForType(type);switch(category){case RoomObjectCategory.FLOOR:return RoomContentLoader.PLACE_HOLDER;case RoomObjectCategory.WALL:return RoomContentLoader.PLACE_HOLDER_WALL;default:if(this._pets[type]!==undefined)return RoomContentLoader.PLACE_HOLDER_PET;return RoomContentLoader.PLACE_HOLDER_DEFAULT;}}getCategoryForType(type){if(!type)return RoomObjectCategory.MINIMUM;if(this._activeObjects[type]!==undefined)return RoomObjectCategory.FLOOR;if(this._wallItems[type]!==undefined)return RoomObjectCategory.WALL;if(this._pets[type]!==undefined)return RoomObjectCategory.UNIT;if(type.indexOf('poster')===0)return RoomObjectCategory.WALL;if(type==='room')return RoomObjectCategory.ROOM;if(type===RoomObjectUserType.USER)return RoomObjectCategory.UNIT;if(type===RoomObjectUserType.PET)return RoomObjectCategory.UNIT;if(type===RoomObjectUserType.BOT)return RoomObjectCategory.UNIT;if(type===RoomObjectUserType.RENTABLE_BOT)return RoomObjectCategory.UNIT;if(type===RoomContentLoader.TILE_CURSOR||type===RoomContentLoader.SELECTION_ARROW)return RoomObjectCategory.CURSOR;return RoomObjectCategory.MINIMUM;}getPetNameForType(type){return Nitro.instance.getConfiguration('pet.types')[type]||null;}isLoaderType(type){type=RoomObjectUserType.getRealType(type);if(type===RoomObjectVisualizationType.USER)return false;return true;}downloadImage(id,type,param){let events=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;let typeName=null;let assetUrls=[];if(type&&type.indexOf(',')>=0){typeName=type;type=typeName.split(',')[0];}if(typeName){assetUrls=this.getAssetUrls(typeName,param,true);}else{assetUrls=this.getAssetUrls(type,param,true);}if(assetUrls&&assetUrls.length){const url=assetUrls[0];const image=new Image();image.src=url;image.onload=()=>{image.onerror=null;this._images.set([type,param].join('_'),image);this._iconListener.onRoomContentLoaded(id,[type,param].join('_'),true);};image.onerror=()=>{image.onload=null;this._logger.error('Failed to download asset: '+url);this._iconListener.onRoomContentLoaded(id,[type,param].join('_'),false);};return true;}return false;}downloadAsset(type,events){const assetUrls=this.getAssetUrls(type);if(!assetUrls||!assetUrls.length)return;if(this._pendingContentTypes.indexOf(type)>=0||this.getOrRemoveEventDispatcher(type))return;this._pendingContentTypes.push(type);this._events.set(type,events);const loader=new Loader();for(const url of assetUrls){if(!url||!url.length)continue;loader.add({url,crossOrigin:'anonymous',loadType:LoaderResource.LOAD_TYPE.XHR,xhrType:LoaderResource.XHR_RESPONSE_TYPE.BUFFER});}let remaining=assetUrls.length;const onDownloaded=(status,url)=>{if(!status){this._logger.error('Failed to download asset: '+url);loader.destroy();events.dispatchEvent(new RoomContentLoadedEvent(RoomContentLoadedEvent.RCLE_FAILURE,type));return;}remaining--;if(!remaining){loader.destroy();const events=this._events.get(type);if(!events)return;events.dispatchEvent(new RoomContentLoadedEvent(RoomContentLoadedEvent.RCLE_SUCCESS,type));return;}};loader.load((loader,resources)=>{for(const key in resources){const resource=resources[key];if(!resource||resource.error||!resource.xhr){onDownloaded(false,resource.url);return;}const resourceType=resource.xhr.getResponseHeader('Content-Type')||'application/octet-stream';if(resourceType==='application/octet-stream'){const nitroBundle=new NitroBundle(resource.data);this.processAsset(nitroBundle.baseTexture,nitroBundle.jsonFile,status=>{onDownloaded(status,resource.url);});continue;}}});}processAsset(baseTexture,data,onDownloaded){const spritesheetData=data.spritesheet;if(!baseTexture||!spritesheetData||!Object.keys(spritesheetData).length){this.createCollection(data,null);onDownloaded(true);return;}const createAsset=()=>{const spritesheet=new Spritesheet(baseTexture,spritesheetData);spritesheet.parse(()=>{this.createCollection(data,spritesheet);onDownloaded(true);});};if(baseTexture.valid){createAsset();}else{baseTexture.once('update',()=>createAsset());}}setAssetAliasName(name,originalName){this._objectAliases.set(name,originalName);this._objectOriginalNames.set(originalName,name);}getAssetAliasName(name){const existing=this._objectAliases.get(name);if(!existing)return name;return existing;}getAssetOriginalName(name){const existing=this._objectOriginalNames.get(name);if(!existing)return name;return existing;}getAssetUrls(type){let param=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;let icon=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;switch(type){case RoomContentLoader.PLACE_HOLDER:return[this.getAssetUrlWithGenericBase(RoomContentLoader.PLACE_HOLDER)];case RoomContentLoader.PLACE_HOLDER_WALL:return[this.getAssetUrlWithGenericBase(RoomContentLoader.PLACE_HOLDER_WALL)];case RoomContentLoader.PLACE_HOLDER_PET:return[this.getAssetUrlWithGenericBase(RoomContentLoader.PLACE_HOLDER_PET)];case RoomContentLoader.ROOM:return[this.getAssetUrlWithGenericBase('room')];case RoomContentLoader.TILE_CURSOR:return[this.getAssetUrlWithGenericBase(RoomContentLoader.TILE_CURSOR)];case RoomContentLoader.SELECTION_ARROW:return[this.getAssetUrlWithGenericBase(RoomContentLoader.SELECTION_ARROW)];default:{const category=this.getCategoryForType(type);if(category===RoomObjectCategory.FLOOR||category===RoomObjectCategory.WALL){const name=this.getAssetAliasName(type);let assetUrl=icon?this.getAssetUrlWithFurniIconBase(name):this.getAssetUrlWithFurniBase(type);if(icon){const active=param&&param!==''&&this._activeObjectTypeIds.has(name+'*'+param);assetUrl=assetUrl.replace(/%param%/gi,active?'_'+param:'');}return[assetUrl];}if(category===RoomObjectCategory.UNIT){return[this.getAssetUrlWithPetBase(type)];}return null;}}}getAssetIconUrl(type,colorIndex){let assetName=null;let assetUrls=[];if(type&&type.indexOf(',')>=0){assetName=type;type=assetName.split(',')[0];}if(assetName){assetUrls=this.getAssetUrls(assetName,colorIndex,true);}else{assetUrls=this.getAssetUrls(type,colorIndex,true);}if(assetUrls&&assetUrls.length)return assetUrls[0];return null;}getAssetUrlWithGenericBase(assetName){return Nitro.instance.getConfiguration('generic.asset.url').replace(/%libname%/gi,assetName);}getAssetUrlWithFurniBase(assetName){return Nitro.instance.getConfiguration('furni.asset.url').replace(/%libname%/gi,assetName);}getAssetUrlWithFurniIconBase(assetName){return Nitro.instance.getConfiguration('furni.asset.icon.url').replace(/%libname%/gi,assetName);}getAssetUrlWithPetBase(assetName){return Nitro.instance.getConfiguration('pet.asset.url').replace(/%libname%/gi,assetName);}setRoomObjectRoomId(object,roomId){const model=object&&object.model;if(!model)return;model.setValue(RoomObjectVariable.OBJECT_ROOM_ID,roomId);}getOrRemoveEventDispatcher(type){let remove=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;const existing=this._events.get(type);if(remove)this._events.delete(type);return existing;}setIconListener(listener){this._iconListener=listener;}}RoomContentLoader.PLACE_HOLDER='place_holder';RoomContentLoader.PLACE_HOLDER_WALL='place_holder_wall';RoomContentLoader.PLACE_HOLDER_PET='place_holder_pet';RoomContentLoader.PLACE_HOLDER_DEFAULT=RoomContentLoader.PLACE_HOLDER;RoomContentLoader.ROOM='room';RoomContentLoader.TILE_CURSOR='tile_cursor';RoomContentLoader.SELECTION_ARROW='selection_arrow';RoomContentLoader.LOADER_READY='RCL_LOADER_READY';RoomContentLoader.MANDATORY_LIBRARIES=[RoomContentLoader.PLACE_HOLDER,RoomContentLoader.PLACE_HOLDER_WALL,RoomContentLoader.PLACE_HOLDER_PET,RoomContentLoader.ROOM,RoomContentLoader.TILE_CURSOR,RoomContentLoader.SELECTION_ARROW];","map":null,"metadata":{},"sourceType":"module"}