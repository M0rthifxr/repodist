{"ast":null,"code":"import{Graphics}from'@pixi/graphics';import{Point,Rectangle}from'@pixi/math';import{TextureUtils}from'../../../../../../../room/utils/TextureUtils';import{Vector3d}from'../../../../../../../room/utils/Vector3d';import{RoomVisualization}from'../../RoomVisualization';import{Randomizer}from'../../utils/Randomizer';import{PlaneMaterialCellColumn}from'./PlaneMaterialCellColumn';export class PlaneMaterialCellMatrix{//1\n//1\nconstructor(totalColumns){let repeatMode=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;let align=arguments.length>2&&arguments[2]!==undefined?arguments[2]:1;let normalMinX=arguments.length>3&&arguments[3]!==undefined?arguments[3]:-1;let normalMaxX=arguments.length>4&&arguments[4]!==undefined?arguments[4]:1;let normalMinY=arguments.length>5&&arguments[5]!==undefined?arguments[5]:-1;let normalMaxY=arguments.length>6&&arguments[6]!==undefined?arguments[6]:1;this._columns=void 0;this._repeatMode=1;this._align=1;this._cachedBitmapData=void 0;this._cachedBitmapNormal=null;this._cachedBitmapHeight=0;this._isCached=false;this._isStatic=true;this._normalMinX=-1;this._normalMaxX=1;this._normalMinY=-1;this._normalMaxY=1;this._columns=[];if(totalColumns<1){totalColumns=1;}let _local_8=0;while(_local_8<totalColumns){this._columns.push(null);_local_8++;}this._repeatMode=repeatMode;this._align=align;this._normalMinX=normalMinX;this._normalMaxX=normalMaxX;this._normalMinY=normalMinY;this._normalMaxY=normalMaxY;if(this._repeatMode==PlaneMaterialCellMatrix.REPEAT_MODE_RANDOM){this._isStatic=false;}}static nextRandomColumnIndex(totalColumns){return Randomizer.getValues(1,0,totalColumns*17631)[0]%totalColumns;}get normalMinX(){return this._normalMinX;}get normalMaxX(){return this._normalMaxX;}get normalMinY(){return this._normalMinY;}get normalMaxY(){return this._normalMaxY;}isBottomAligned(){return this._align===PlaneMaterialCellMatrix.ALIGN_BOTTOM;}get isStatic(){return this._isStatic;}dispose(){if(this._cachedBitmapData){this._cachedBitmapData.destroy();this._cachedBitmapData=null;}if(this._cachedBitmapNormal)this._cachedBitmapNormal=null;}clearCache(){if(!this._isCached)return;if(this._cachedBitmapData){this._cachedBitmapData.destroy();this._cachedBitmapData=null;}if(this._cachedBitmapNormal){this._cachedBitmapNormal.x=0;this._cachedBitmapNormal.y=0;this._cachedBitmapNormal.z=0;}if(this._columns&&this._columns.length){for(const column of this._columns){if(!column)continue;column.clearCache();}}this._isCached=false;}createColumn(index,width,cells){let repeatMode=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1;if(index<0||index>=this._columns.length)return false;const newColumn=new PlaneMaterialCellColumn(width,cells,repeatMode);const oldColumn=this._columns[index];if(oldColumn)oldColumn.dispose();this._columns[index]=newColumn;if(newColumn&&!newColumn.isStatic)this._isStatic=false;return true;}render(canvas,width,height,normal,useTexture,offsetX,offsetY,topAlign){if(width<1)width=1;if(height<1)height=1;if(!canvas||canvas.width!==width||canvas.height!==height)canvas=null;if(!this._cachedBitmapNormal)this._cachedBitmapNormal=new Vector3d();if(this.isStatic){if(this._cachedBitmapData){if(this._cachedBitmapData.width===width&&this._cachedBitmapData.height==height&&Vector3d.isEqual(this._cachedBitmapNormal,normal)){if(canvas){this.copyCachedBitmapOnCanvas(canvas,this._cachedBitmapHeight,offsetY,topAlign);return canvas;}return this._cachedBitmapData;}this._cachedBitmapData.destroy();this._cachedBitmapData=null;}}else{if(this._cachedBitmapData){if(this._cachedBitmapData.width===width&&this._cachedBitmapData.height===height){this._cachedBitmapData.beginFill(0xFFFFFF).drawRect(0,0,width,height).endFill();}else{this._cachedBitmapData.destroy();this._cachedBitmapData=null;}}}this._isCached=true;this._cachedBitmapNormal.assign(normal);if(!useTexture){this._cachedBitmapHeight=height;if(!this._cachedBitmapData){const graphic=new Graphics().beginFill(0xFFFFFF).drawRect(0,0,width,height).endFill();this._cachedBitmapData=graphic;}else{this._cachedBitmapData.beginFill(0xFFFFFF).drawRect(0,0,width,height).endFill();}if(canvas){this.copyCachedBitmapOnCanvas(canvas,height,offsetY,topAlign);return canvas;}return this._cachedBitmapData;}if(!this._cachedBitmapData){this._cachedBitmapHeight=height;const graphic=new Graphics().beginFill(0xFFFFFF).drawRect(0,0,width,height).endFill();this._cachedBitmapData=graphic;}const columns=[];let columnIndex=0;while(columnIndex<this._columns.length){const column=this._columns[columnIndex];if(column){const columnBitmapData=column.render(height,normal,offsetX,offsetY);if(columnBitmapData)columns.push(columnBitmapData);}columnIndex++;}if(!columns.length){if(canvas)return canvas;return this._cachedBitmapData;}let maxColumnHeight=0;switch(this._repeatMode){case PlaneMaterialCellMatrix.REPEAT_MODE_BORDERS://     maxColumnHeight = this.renderRepeatBorders(this._cachedBitmapData, columns);\nbreak;case PlaneMaterialCellMatrix.REPEAT_MODE_CENTER://     maxColumnHeight = this.renderRepeatCenter(this._cachedBitmapData, columns);\nbreak;case PlaneMaterialCellMatrix.REPEAT_MODE_FIRST://     maxColumnHeight = this.renderRepeatFirst(this._cachedBitmapData, columns);\nbreak;case PlaneMaterialCellMatrix.REPEAT_MODE_LAST://     maxColumnHeight = this.renderRepeatLast(this._cachedBitmapData, columns);\nbreak;case PlaneMaterialCellMatrix.REPEAT_MODE_RANDOM://     maxColumnHeight = this.renderRepeatRandom(this._cachedBitmapData, columns);\nbreak;default:maxColumnHeight=this.renderRepeatAll(this._cachedBitmapData,columns);break;}this._cachedBitmapHeight=maxColumnHeight;if(canvas){this.copyCachedBitmapOnCanvas(canvas,maxColumnHeight,offsetY,topAlign);return canvas;}return this._cachedBitmapData;}copyCachedBitmapOnCanvas(canvas,height,offsetY,topAlign){if(!canvas||!this._cachedBitmapData||canvas===this._cachedBitmapData)return;if(!topAlign)offsetY=canvas.height-height-offsetY;let _local_5;if(this._align==PlaneMaterialCellMatrix.ALIGN_TOP){_local_5=new Rectangle(0,0,this._cachedBitmapData.width,this._cachedBitmapHeight);}else{_local_5=new Rectangle(0,this._cachedBitmapData.height-this._cachedBitmapHeight,this._cachedBitmapData.width,this._cachedBitmapHeight);}const texture=TextureUtils.generateTexture(this._cachedBitmapData,_local_5);if(texture){canvas.beginTextureFill({texture}).drawRect(0,offsetY,_local_5.width,_local_5.height).endFill();}}getColumnsWidth(columns){if(!columns||!columns.length)return 0;let width=0;for(const graphic of columns){if(!graphic)continue;width+=graphic.width;}return width;}renderColumns(canvas,columns,x,flag){if(!canvas||!columns||!columns.length)return new Point(x,0);let height=0;let i=0;while(i<columns.length){const column=flag?columns[i]:columns[columns.length-1-i];if(column){if(!flag)x=x-column.width;let y=0;if(this._align==PlaneMaterialCellMatrix.ALIGN_BOTTOM)y=canvas.height-column.height;let texture=RoomVisualization.getTextureCache(column);if(!texture){texture=TextureUtils.generateTexture(column,new Rectangle(0,0,column.width,column.height));RoomVisualization.addTextureCache(column,texture);}canvas.beginTextureFill({texture});canvas.drawRect(x,y,texture.width,texture.height);canvas.endFill();if(column.height>height)height=column.height;if(flag)x=x+column.width;if(flag&&x>=canvas.width||!flag&&x<=0)return new Point(x,height);}i++;}return new Point(x,height);}renderRepeatAll(canvas,columns){if(!canvas||!columns||!columns.length)return 0;const totalWidth=this.getColumnsWidth(columns);let x=0;let y=0;while(x<canvas.width){const point=this.renderColumns(canvas,columns,x,true);x=point.x;if(point.y>y)y=point.y;if(!point.x)return y;}return y;}// private renderRepeatBorders(k:BitmapData, _arg_2:Array): number\n// {\n//     if ((((_arg_2 == null) || (_arg_2.length == 0)) || (k == null)))\n//     {\n//         return 0;\n//     }\n//     var _local_3: number;\n//     var _local_4:BitmapData;\n//     var _local_5:Array = [];\n//     var _local_6: number;\n//     var _local_7: number;\n//     _local_7 = 1;\n//     while (_local_7 < (_arg_2.length - 1))\n//     {\n//         _local_4 = (_arg_2[_local_7] as BitmapData);\n//         if (_local_4 != null)\n//         {\n//             _local_6 = (_local_6 + _local_4.width);\n//             _local_5.push(_local_4);\n//         }\n//         _local_7++;\n//     }\n//     if (this._columns.length == 1)\n//     {\n//         _local_4 = (this._columns[0] as BitmapData);\n//         if (_local_4 != null)\n//         {\n//             _local_6 = _local_4.width;\n//             _local_5.push(_local_4);\n//         }\n//     }\n//     var _local_8:* = ((k.width - _local_6) >> 1);\n//     var _local_9:Point;\n//     _local_9 = this.renderColumns(k, _local_5, _local_8, true);\n//     var _local_10: number = _local_9.x;\n//     if (_local_9.y > _local_3)\n//     {\n//         _local_3 = _local_9.y;\n//     }\n//     _local_4 = (_arg_2[0] as BitmapData);\n//     if (_local_4 != null)\n//     {\n//         _local_5 = [_local_4];\n//         while (_local_8 >= 0)\n//         {\n//             _local_9 = this.renderColumns(k, _local_5, _local_8, false);\n//             _local_8 = _local_9.x;\n//             if (_local_9.y > _local_3)\n//             {\n//                 _local_3 = _local_9.y;\n//             }\n//         }\n//     }\n//     _local_4 = (_arg_2[(_arg_2.length - 1)] as BitmapData);\n//     if (_local_4 != null)\n//     {\n//         _local_5 = [_local_4];\n//         while (_local_10 < k.height)\n//         {\n//             _local_9 = this.renderColumns(k, _local_5, _local_10, true);\n//             _local_10 = _local_9.x;\n//             if (_local_9.y > _local_3)\n//             {\n//                 _local_3 = _local_9.y;\n//             }\n//         }\n//     }\n//     return _local_3;\n// }\n// private renderRepeatCenter(k:BitmapData, _arg_2:Array): number\n// {\n//     var _local_14: number;\n//     var _local_15: number;\n//     var _local_16: number;\n//     var _local_17: number;\n//     var _local_18:Array;\n//     if ((((_arg_2 == null) || (_arg_2.length == 0)) || (k == null)))\n//     {\n//         return 0;\n//     }\n//     var _local_3: number;\n//     var _local_4:BitmapData;\n//     var _local_5:Array = [];\n//     var _local_6:Array = [];\n//     var _local_7: number;\n//     var _local_8: number;\n//     var _local_9: number;\n//     _local_9 = 0;\n//     while (_local_9 < (_arg_2.length >> 1))\n//     {\n//         _local_4 = (_arg_2[_local_9] as BitmapData);\n//         if (_local_4 != null)\n//         {\n//             _local_7 = (_local_7 + _local_4.width);\n//             _local_5.push(_local_4);\n//         }\n//         _local_9++;\n//     }\n//     _local_9 = ((_arg_2.length >> 1) + 1);\n//     while (_local_9 < _arg_2.length)\n//     {\n//         _local_4 = (_arg_2[_local_9] as BitmapData);\n//         if (_local_4 != null)\n//         {\n//             _local_8 = (_local_8 + _local_4.width);\n//             _local_6.push(_local_4);\n//         }\n//         _local_9++;\n//     }\n//     var _local_10:Point;\n//     var _local_11: number;\n//     var _local_12: number;\n//     var _local_13: number = k.width;\n//     if ((_local_7 + _local_8) > k.width)\n//     {\n//         _local_11 = ((_local_7 + _local_8) - k.width);\n//         _local_12 = (_local_12 - (_local_11 >> 1));\n//         _local_13 = (_local_13 + (_local_11 - (_local_11 >> 1)));\n//     }\n//     if (_local_11 == 0)\n//     {\n//         _local_4 = (_arg_2[(_arg_2.length >> 1)] as BitmapData);\n//         if (_local_4 != null)\n//         {\n//             _local_14 = _local_4.width;\n//             _local_15 = (k.width - (_local_7 + _local_8));\n//             _local_16 = (Math.ceil((_local_15 / _local_14)) * _local_14);\n//             _local_12 = (_local_7 - ((_local_16 - _local_15) >> 1));\n//             _local_17 = (_local_12 + _local_16);\n//             _local_18 = [_local_4];\n//             while (_local_12 < _local_17)\n//             {\n//                 _local_10 = this.renderColumns(k, _local_18, _local_12, true);\n//                 _local_12 = _local_10.x;\n//                 if (_local_10.y > _local_3)\n//                 {\n//                     _local_3 = _local_10.y;\n//                 }\n//             }\n//         }\n//     }\n//     _local_12 = 0;\n//     _local_10 = this.renderColumns(k, _local_5, _local_12, true);\n//     if (_local_10.y > _local_3)\n//     {\n//         _local_3 = _local_10.y;\n//     }\n//     _local_10 = this.renderColumns(k, _local_6, _local_13, false);\n//     if (_local_10.y > _local_3)\n//     {\n//         _local_3 = _local_10.y;\n//     }\n//     return _local_3;\n// }\n// private renderRepeatFirst(k:BitmapData, _arg_2:Array): number\n// {\n//     var _local_7:Array;\n//     if ((((_arg_2 == null) || (_arg_2.length == 0)) || (k == null)))\n//     {\n//         return 0;\n//     }\n//     var _local_3: number;\n//     var _local_4:BitmapData;\n//     var _local_5: number = k.width;\n//     var _local_6:Point = this.renderColumns(k, _arg_2, _local_5, false);\n//     _local_5 = _local_6.x;\n//     if (_local_6.y > _local_3)\n//     {\n//         _local_3 = _local_6.y;\n//     }\n//     _local_4 = (_arg_2[0] as BitmapData);\n//     if (_local_4 != null)\n//     {\n//         _local_7 = [_local_4];\n//         while (_local_5 >= 0)\n//         {\n//             _local_6 = this.renderColumns(k, _local_7, _local_5, false);\n//             _local_5 = _local_6.x;\n//             if (_local_6.y > _local_3)\n//             {\n//                 _local_3 = _local_6.y;\n//             }\n//         }\n//     }\n//     return _local_3;\n// }\n// private renderRepeatLast(k:BitmapData, _arg_2:Array): number\n// {\n//     var _local_7:Array;\n//     if ((((_arg_2 == null) || (_arg_2.length == 0)) || (k == null)))\n//     {\n//         return 0;\n//     }\n//     var _local_3: number;\n//     var _local_4:BitmapData;\n//     var _local_5: number;\n//     var _local_6:Point = this.renderColumns(k, _arg_2, _local_5, true);\n//     _local_5 = _local_6.x;\n//     if (_local_6.y > _local_3)\n//     {\n//         _local_3 = _local_6.y;\n//     }\n//     _local_4 = (_arg_2[(_arg_2.length - 1)] as BitmapData);\n//     if (_local_4 != null)\n//     {\n//         _local_7 = [_local_4];\n//         while (_local_5 < k.width)\n//         {\n//             _local_6 = this.renderColumns(k, _local_7, _local_5, true);\n//             _local_5 = _local_6.x;\n//             if (_local_6.y > _local_3)\n//             {\n//                 _local_3 = _local_6.y;\n//             }\n//         }\n//     }\n//     return _local_3;\n// }\n// private renderRepeatRandom(k:BitmapData, _arg_2:Array): number\n// {\n//     var _local_6:Array;\n//     var _local_7:Point;\n//     if ((((_arg_2 == null) || (_arg_2.length == 0)) || (k == null)))\n//     {\n//         return 0;\n//     }\n//     var _local_3: number;\n//     var _local_4:BitmapData;\n//     var _local_5: number;\n//     while (_local_5 < k.width)\n//     {\n//         _local_4 = (_arg_2[nextRandomColumnIndex(_arg_2.length)] as BitmapData);\n//         if (_local_4 != null)\n//         {\n//             _local_6 = [_local_4];\n//             _local_7 = this.renderColumns(k, _local_6, _local_5, true);\n//             _local_5 = _local_7.x;\n//             if (_local_7.y > _local_3)\n//             {\n//                 _local_3 = _local_7.y;\n//             }\n//         }\n//         else\n//         {\n//             return _local_3;\n//         }\n//     }\n//     return _local_3;\n// }\ngetColumns(width){if(this._repeatMode===PlaneMaterialCellMatrix.REPEAT_MODE_RANDOM){const columns=[];let columnIndex=0;while(columnIndex<width){const column=this._columns[PlaneMaterialCellMatrix.nextRandomColumnIndex(this._columns.length)];if(column){columns.push(column);if(column.width>1)columnIndex+=column.width;else break;}}return columns;}return this._columns;}}PlaneMaterialCellMatrix.REPEAT_MODE_ALL=1;PlaneMaterialCellMatrix.REPEAT_MODE_BORDERS=2;PlaneMaterialCellMatrix.REPEAT_MODE_CENTER=3;PlaneMaterialCellMatrix.REPEAT_MODE_FIRST=4;PlaneMaterialCellMatrix.REPEAT_MODE_LAST=5;PlaneMaterialCellMatrix.REPEAT_MODE_RANDOM=6;PlaneMaterialCellMatrix.REPEAT_MODE_DEFAULT=PlaneMaterialCellMatrix.REPEAT_MODE_ALL;PlaneMaterialCellMatrix.MIN_NORMAL_COORDINATE_VALUE=-1;PlaneMaterialCellMatrix.MAX_NORMAL_COORDINATE_VALUE=1;PlaneMaterialCellMatrix.ALIGN_TOP=1;PlaneMaterialCellMatrix.ALIGN_BOTTOM=2;PlaneMaterialCellMatrix.ALIGN_DEFAULT=PlaneMaterialCellMatrix.ALIGN_TOP;","map":null,"metadata":{},"sourceType":"module"}