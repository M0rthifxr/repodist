{"ast":null,"code":"import{useCallback,useEffect,useState}from'react';import{RoomWidgetPollMessage,RoomWidgetWordQuizUpdateEvent}from'../../../../api';import{UseEventDispatcherHook}from'../../../../hooks';import{useRoomContext}from'../../RoomContext';import{VALUE_KEY_DISLIKE,VALUE_KEY_LIKE}from'./common/VoteValue';import{WordQuizQuestionView}from'./WordQuizQuestionView';import{WordQuizVoteView}from'./WordQuizVoteView';import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const DEFAULT_DISPLAY_DELAY=4000;const SIGN_FADE_DELAY=3;export const WordQuizWidgetView=props=>{const[pollId,setPollId]=useState(-1);const[question,setQuestion]=useState(null);const[answerSent,setAnswerSent]=useState(false);const[questionClearTimeout,setQuestionClearTimeout]=useState(null);const[answerCounts,setAnswerCounts]=useState(new Map());const[userAnswers,setUserAnswers]=useState(new Map());const{eventDispatcher=null,widgetHandler=null,roomSession=null}=useRoomContext();const clearQuestion=useCallback(()=>{setPollId(-1);setQuestion(null);},[]);const onRoomWidgetWordQuizUpdateEvent=useCallback(event=>{switch(event.type){case RoomWidgetWordQuizUpdateEvent.NEW_QUESTION:setPollId(event.id);setQuestion(event.question);setAnswerSent(false);setAnswerCounts(new Map());setUserAnswers(new Map());setQuestionClearTimeout(prevValue=>{if(prevValue)clearTimeout(prevValue);if(event.duration>0){const delay=event.duration<1000?DEFAULT_DISPLAY_DELAY:event.duration;return setTimeout(()=>clearQuestion(),delay);}return null;});break;case RoomWidgetWordQuizUpdateEvent.QUESTION_ANSWERED:{const userData=roomSession.userDataManager.getUserData(event.userId);if(!userData)return;setAnswerCounts(event.answerCounts);setUserAnswers(prevValue=>{if(!prevValue.has(userData.roomIndex)){const newValue=new Map(userAnswers);newValue.set(userData.roomIndex,{value:event.value,secondsLeft:SIGN_FADE_DELAY});return newValue;}return prevValue;});break;}case RoomWidgetWordQuizUpdateEvent.QUESTION_FINISHED:if(question&&question.id===event.questionId){setAnswerCounts(event.answerCounts);setAnswerSent(true);setQuestionClearTimeout(prevValue=>{if(prevValue)clearTimeout(prevValue);return setTimeout(()=>clearQuestion(),DEFAULT_DISPLAY_DELAY);});}setUserAnswers(new Map());break;}},[question,roomSession.userDataManager,userAnswers,clearQuestion]);UseEventDispatcherHook(RoomWidgetWordQuizUpdateEvent.NEW_QUESTION,eventDispatcher,onRoomWidgetWordQuizUpdateEvent);UseEventDispatcherHook(RoomWidgetWordQuizUpdateEvent.QUESTION_ANSWERED,eventDispatcher,onRoomWidgetWordQuizUpdateEvent);UseEventDispatcherHook(RoomWidgetWordQuizUpdateEvent.QUESTION_FINISHED,eventDispatcher,onRoomWidgetWordQuizUpdateEvent);const vote=useCallback(vote=>{if(answerSent||!question)return;const updateMessage=new RoomWidgetPollMessage(RoomWidgetPollMessage.ANSWER,pollId);updateMessage.questionId=question.id;updateMessage.answers=[vote];widgetHandler.processWidgetMessage(updateMessage);setAnswerSent(true);},[answerSent,pollId,question,widgetHandler]);const checkSignFade=useCallback(()=>{setUserAnswers(prevValue=>{const keysToRemove=[];prevValue.forEach((value,key)=>{value.secondsLeft--;if(value.secondsLeft<=0)keysToRemove.push(key);});if(keysToRemove.length===0)return prevValue;const copy=new Map(prevValue);keysToRemove.forEach(key=>copy.delete(key));return copy;});},[]);useEffect(()=>{const interval=setInterval(()=>checkSignFade(),1000);return()=>clearInterval(interval);},[checkSignFade]);useEffect(()=>{return()=>{setQuestionClearTimeout(prev=>{if(prev)clearTimeout(prev);return null;});};},[]);return/*#__PURE__*/_jsxs(_Fragment,{children:[question&&/*#__PURE__*/_jsx(WordQuizQuestionView,{question:question.content,canVote:!answerSent,vote:vote,noVotes:answerCounts.get(VALUE_KEY_DISLIKE)||0,yesVotes:answerCounts.get(VALUE_KEY_LIKE)||0}),userAnswers&&Array.from(userAnswers.entries()).map((_ref,index)=>{let[key,value]=_ref;return/*#__PURE__*/_jsx(WordQuizVoteView,{userIndex:key,vote:value.value},index);})]});};","map":null,"metadata":{},"sourceType":"module"}