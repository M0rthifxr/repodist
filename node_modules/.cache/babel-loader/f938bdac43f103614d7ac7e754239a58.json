{"ast":null,"code":"import{FollowFriendMessageComposer}from'@nitrots/nitro-renderer';import{useEffect,useRef,useState}from'react';import{AddEventLinkTracker,GetUserProfile,LocalizeText,RemoveLinkEventTracker,SendMessageComposer}from'../../../../api';import{ButtonGroup,Column,Flex,LayoutAvatarImageView,LayoutBadgeImageView,LayoutItemCountView,NitroCardContentView,NitroCardHeaderView,NitroCardView}from'../../../../common';import{LayoutMessengerGrid}from'../../../../common/layout/LayoutMessengerGrid';import{useMessenger}from'../../../../hooks';import{FriendsMessengerThreadView}from'./messenger-thread/FriendsMessengerThreadView';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";export const FriendsMessengerView=props=>{const[isVisible,setIsVisible]=useState(false);const[lastThreadId,setLastThreadId]=useState(-1);const[messageText,setMessageText]=useState('');const{visibleThreads=[],activeThread=null,getMessageThread=null,sendMessage=null,setActiveThreadId=null,closeThread=null}=useMessenger();const messagesBox=useRef();const followFriend=()=>activeThread&&activeThread.participant&&SendMessageComposer(new FollowFriendMessageComposer(activeThread.participant.id));const openProfile=()=>activeThread&&activeThread.participant&&GetUserProfile(activeThread.participant.id);const send=()=>{if(!activeThread||!messageText.length)return;sendMessage(activeThread,messageText);setMessageText('');};const onKeyDown=event=>{if(event.key!=='Enter')return;send();};useEffect(()=>{const linkTracker={linkReceived:url=>{const parts=url.split('/');if(parts.length===2){if(parts[1]==='open'){setIsVisible(true);return;}else{const thread=getMessageThread(parseInt(parts[1]));if(!thread)return;setActiveThreadId(thread.threadId);setIsVisible(true);}}},eventUrlPrefix:'friends-messenger/'};AddEventLinkTracker(linkTracker);return()=>RemoveLinkEventTracker(linkTracker);},[getMessageThread,setActiveThreadId]);useEffect(()=>{if(!isVisible||!activeThread)return;messagesBox.current.scrollTop=messagesBox.current.scrollHeight;},[isVisible,activeThread]);useEffect(()=>{if(isVisible&&!activeThread){if(lastThreadId>0){setActiveThreadId(lastThreadId);}else{if(visibleThreads.length>0)setActiveThreadId(visibleThreads[0].threadId);}return;}if(!isVisible&&activeThread){setLastThreadId(activeThread.threadId);setActiveThreadId(-1);}},[isVisible,activeThread,lastThreadId,visibleThreads,setActiveThreadId]);if(!isVisible)return null;return/*#__PURE__*/_jsxs(NitroCardView,{className:\"nitro-friends-messenger\",uniqueKey:\"nitro-friends-messenger\",theme:\"messenger\",children:[/*#__PURE__*/_jsx(NitroCardHeaderView,{headerText:LocalizeText('messenger.window.title',['OPEN_CHAT_COUNT'],[visibleThreads.length.toString()]),onCloseClick:event=>setIsVisible(false)}),/*#__PURE__*/_jsxs(NitroCardContentView,{children:[/*#__PURE__*/_jsx(Column,{fullWidth:true,size:4,children:/*#__PURE__*/_jsx(\"div\",{className:\"d-flex h-100 overflow-auto gap-2\",children:visibleThreads&&visibleThreads.length>0&&visibleThreads.map(thread=>{return/*#__PURE__*/_jsxs(LayoutMessengerGrid,{itemActive:activeThread===thread,onClick:event=>setActiveThreadId(thread.threadId),children:[thread.unread&&/*#__PURE__*/_jsx(LayoutItemCountView,{count:thread.unreadCount}),/*#__PURE__*/_jsx(Flex,{fullWidth:true,alignItems:\"center\",gap:1,children:/*#__PURE__*/_jsxs(Flex,{alignItems:\"center\",className:\"friend-head px-1\",children:[thread.participant.id>0&&/*#__PURE__*/_jsx(LayoutAvatarImageView,{figure:thread.participant.figure,headOnly:true,direction:2}),thread.participant.id<=0&&/*#__PURE__*/_jsx(LayoutBadgeImageView,{isGroup:true,badgeCode:thread.participant.figure})]})})]},thread.threadId);})})}),/*#__PURE__*/_jsx(Column,{size:8,overflow:\"hidden\",className:\"w-100\",children:activeThread&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"messenger-line\",children:/*#__PURE__*/_jsx(\"p\",{className:\"nitro-messenger-header-text fw-bold\",children:LocalizeText('messenger.window.separator',['FRIEND_NAME'],[activeThread.participant.name])})}),/*#__PURE__*/_jsxs(Flex,{alignItems:\"center\",justifyContent:\"between\",gap:1,children:[/*#__PURE__*/_jsxs(Flex,{gap:1,children:[/*#__PURE__*/_jsxs(ButtonGroup,{className:\"gap-1\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"follow\",onClick:followFriend}),/*#__PURE__*/_jsx(\"button\",{className:\"profile\",onClick:openProfile})]}),/*#__PURE__*/_jsx(\"button\",{className:\"messenger-button fw-bold px-3\",onClick:openProfile,children:LocalizeText('messenger.window.button.report')})]}),/*#__PURE__*/_jsx(\"button\",{className:\"clear\",onClick:event=>closeThread(activeThread.threadId)})]}),/*#__PURE__*/_jsx(Column,{fit:true,className:\"chat-messages\",children:/*#__PURE__*/_jsx(Column,{innerRef:messagesBox,overflow:\"auto\",children:/*#__PURE__*/_jsx(FriendsMessengerThreadView,{thread:activeThread})})}),/*#__PURE__*/_jsxs(Flex,{gap:1,children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"chat-input-form form-control-sm\",maxLength:255,placeholder:LocalizeText('messenger.window.input.default',['FRIEND_NAME'],[activeThread.participant.name]),value:messageText,onChange:event=>setMessageText(event.target.value),onKeyDown:onKeyDown}),/*#__PURE__*/_jsx(\"button\",{className:\"messenger-button chat-submit fw-bold px-3\",onClick:send,children:LocalizeText('widgets.chatinput.say')})]})]})})]})]});};","map":null,"metadata":{},"sourceType":"module"}